{% set title = "编辑服务器" %}
{%set admin = true%}
{% extends "../../base.html" %}

{% block content %}
<!-- 页面容器 -->
<div class="container mx-auto px-2 sm:px-4 flex flex-col md:flex-row gap-3 md:gap-6 justify-center" style="padding-top: calc(1.5rem + env(safe-area-inset-top));">
    <!-- 引入侧边栏 -->
    {% include "../sidebar.html" %}

    <!-- 主内容区域 -->
    <div class="flex-1 md:max-w-4xl bg-slate-900/80 backdrop-blur rounded-lg border border-slate-800/50 p-4 md:p-6">
        <!-- 页面标题 -->
        <div class="flex items-center justify-between mb-6">
            <div class="flex items-center gap-3">
                <i class="material-icons text-purple-500">edit</i>
                <div>
                    <h3 class="text-lg font-medium text-white">{{server.name}}</h3>
                    <p class="text-sm text-slate-400">编辑服务器</p>
                </div>
            </div>
            <!-- 主要操作按钮：保存和删除 -->
            <div class="flex items-center gap-2">
                <button onclick="edit()"
                        class="flex items-center gap-2 px-3 py-1.5 text-sm font-medium text-white bg-purple-500 hover:bg-purple-600 rounded-md transition-colors">
                    <i class="material-icons text-[18px]">save</i>
                    <span>保存</span>
                </button>
                <button onclick="del()"
                        class="flex items-center gap-2 px-3 py-1.5 text-sm font-medium text-white bg-red-500 hover:bg-red-600 rounded-md transition-colors">
                    <i class="material-icons text-[18px]">delete</i>
                    <span>删除</span>
                </button>
            </div>
        </div>

        <!-- 隐藏字段：服务器ID和置顶状态 -->
        <input type="text" id='sid' value="{{server.sid}}" hidden>
        <input type="text" id='edit_top' value="{{server.top}}" hidden>

        <!-- 表单内容区域 -->
        <div class="space-y-6">
            <!-- 基本信息设置 -->
            <div class="space-y-4">
                <h4 class="text-base font-medium text-slate-200">基本信息</h4>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <!-- 服务器名称 -->
                    <div>
                        <label class="block text-sm font-medium text-slate-400 mb-2">服务器名称</label>
                        <input type="text"
                               id="edit_name"
                               value="{{server.name}}"
                               class="w-full px-3 py-2 bg-slate-800/50 border border-slate-700 rounded-md text-slate-200 placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                    </div>
                    <!-- 服务器状态选择 -->
                    <div>
                        <label class="block text-sm font-medium text-slate-400 mb-2">状态</label>
                        <select id="edit_status"
                                class="w-full px-3 py-2 bg-slate-800/50 border border-slate-700 rounded-md text-slate-200 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                            {% for sta in ['1', '2', '0'] %}
                            {% set names = {'1':'正常','2':'对外隐藏','0':'不可用'} %}
                            <option value="{{sta}}" {% if sta==server.status %}selected{% endif %}>{{names[sta]}}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <!-- 到期时间 -->
                    <div>
                        <label class="block text-sm font-medium text-slate-400 mb-2">到期时间</label>
                        <input type="date"
                               id="edit_expire_time"
                               value="{{server.expire_time|formatDate}}"
                               class="w-full px-3 py-2 bg-slate-800/50 border border-slate-700 rounded-md text-slate-200 placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                        <p class="mt-1 text-xs text-slate-500">留空表示永久有效</p>
                    </div>
                    <!-- 服务器分组 -->
                    <div>
                        <label class="block text-sm font-medium text-slate-400 mb-2">服务器分组</label>
                        <select id="edit_group_id"
                                class="w-full px-3 py-2 bg-slate-800/50 border border-slate-700 rounded-md text-slate-200 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                            {% for group in groups %}
                            <option value="{{group.id}}" {% if group.id == server.group_id %}selected{% endif %}>{{group.name}}</option>
                            {% endfor %}
                            {% if not groups or groups.length == 0 %}
                            <option value="default" {% if server.group_id == 'default' %}selected{% endif %}>默认分组</option>
                            {% endif %}
                        </select>
                    </div>
                </div>
            </div>

            <!-- SSH连接设置 -->
            <div class="space-y-4">
                <h4 class="text-base font-medium text-slate-200">SSH 设置</h4>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <!-- SSH连接参数：主机、端口、用户名 -->
                    <div>
                        <label class="block text-sm font-medium text-slate-400 mb-2">域名/IP</label>
                        <input type="text"
                               id="edit_ssh_host"
                               value="{{server.data.ssh.host}}"
                               placeholder="IPv4或IPv6地址，如: 192.168.1.1 或 2001:db8::1"
                               class="w-full px-3 py-2 bg-slate-800/50 border border-slate-700 rounded-md text-slate-200 placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                        <p class="mt-1 text-xs text-slate-500">支持IPv4和IPv6地址，IPv6地址无需添加方括号</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-400 mb-2">端口</label>
                        <input type="number"
                               id="edit_ssh_port"
                               value="{{server.data.ssh.port}}"
                               class="w-full px-3 py-2 bg-slate-800/50 border border-slate-700 rounded-md text-slate-200 placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-400 mb-2">用户名</label>
                        <input type="text"
                               id="edit_ssh_username"
                               value="{{server.data.ssh.username}}"
                               class="w-full px-3 py-2 bg-slate-800/50 border border-slate-700 rounded-md text-slate-200 placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-400 mb-2">密码 (可选)</label>
                        <div class="relative">
                            <input type="password"
                                   id="edit_ssh_password"
                                   value="{{server.data.ssh.password}}"
                                   class="w-full px-3 py-2 bg-slate-800/50 border border-slate-700 rounded-md text-slate-200 placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                            <span class="absolute inset-y-0 right-0 flex items-center pr-3 cursor-pointer toggle-password">
                                <i class="material-icons text-slate-500">visibility</i>
                            </span>
                        </div>
                    </div>

                    <!-- 修改为跨三格的私钥设置区域 -->
                    <div class="md:col-span-2 lg:col-span-3">
                        <div class="bg-slate-800/30 p-4 rounded-lg space-y-3">
                            <label class="block text-sm font-medium text-slate-400">私钥 (可选)</label>
                            <div class="relative">
                                <input type="password"
                                       id="edit_ssh_pri"
                                       value="{{server.data.ssh.pri}}"
                                       class="w-full px-3 py-2 bg-slate-800/50 border border-slate-700 rounded-md text-slate-200 placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                                <span class="absolute inset-y-0 right-0 flex items-center pr-3 cursor-pointer toggle-password">
                                    <i class="material-icons text-slate-500">visibility</i>
                                </span>
                            </div>

                            <!-- 新增：私钥密码字段 -->
                            <div>
                                <label class="block text-sm font-medium text-slate-400 mb-2">私钥密码 (如果有)</label>
                                <input type="password"
                                       id="edit_ssh_passphrase"
                                       placeholder="如果私钥有密码保护，请在此输入"
                                       class="w-full px-3 py-2 bg-slate-800/50 border border-slate-700 rounded-md text-slate-200 placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                            </div>

                            <div class="mt-3">
                                <p class="text-xs text-slate-500 mb-2">支持 RSA、ED25519 和 PKCS8 格式的私钥</p>
                                <div class="flex items-center space-x-2">
                                    <input type="file"
                                           id="edit_ssh_pri_file"
                                           class="hidden"
                                           accept=".pem,.key,.ppk">
                                    <button type="button"
                                            onclick="document.getElementById('edit_ssh_pri_file').click()"
                                            class="px-3 py-1 text-xs bg-slate-700 hover:bg-slate-600 text-white rounded">
                                        <i class="material-icons text-[14px] align-text-bottom">upload_file</i>
                                        上传私钥文件
                                    </button>
                                    <button type="button"
                                            onclick="testSSHConnection()"
                                            class="px-3 py-1 text-xs bg-blue-500 hover:bg-blue-600 text-white rounded">
                                        <i class="material-icons text-[14px] align-text-bottom">check_circle</i>
                                        测试连接
                                    </button>
                                </div>
                                <!-- 连接结果 -->
                                <div id="ssh-test-result" class="mt-2 text-sm hidden"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 流量设置 -->
            <div class="space-y-4">
                <h4 class="text-base font-medium text-slate-200">流量设置</h4>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <!-- 每月流量限制 -->
                    <div>
                        <label class="block text-sm font-medium text-slate-400 mb-2">每月流量限制 (GB)</label>
                        <input type="number"
                               id="edit_traffic_limit"
                               value="{{server.traffic_limit|bytesToGB}}"
                               class="w-full px-3 py-2 bg-slate-800/50 border border-slate-700 rounded-md text-slate-200 placeholder-slate-400"
                               placeholder="0">
                    </div>

                    <!-- 流量重置日 -->
                    <div>
                        <label class="block text-sm font-medium text-slate-400 mb-2">流量重置日</label>
                        <input type="number"
                               id="edit_traffic_reset_day"
                               value="{{server.traffic_reset_day|default(1)}}"
                               min="1"
                               max="31"
                               class="w-full px-3 py-2 bg-slate-800/50 border border-slate-700 rounded-md text-slate-200 placeholder-slate-400"
                               placeholder="1">
                    </div>

                    <!-- 流量预警阈值 -->
                    <div>
                        <label class="block text-sm font-medium text-slate-400 mb-2">流量预警阈值 (%)</label>
                        <input type="number"
                               id="edit_traffic_alert_percent"
                               value="{{server.traffic_alert_percent|default(80)}}"
                               min="0"
                               max="100"
                               class="w-full px-3 py-2 bg-slate-800/50 border border-slate-700 rounded-md text-slate-200 placeholder-slate-400"
                               placeholder="80">
                    </div>

                    <!-- 流量校准日期 -->
                    <div>
                        <label class="block text-sm font-medium text-slate-400 mb-2">流量校准日期</label>
                        <input type="date"
                               id="edit_traffic_calibration_date"
                               value="{{server.traffic_calibration_date|formatDate}}"
                               class="w-full px-3 py-2 bg-slate-800/50 border border-slate-700 rounded-md text-slate-200 placeholder-slate-400">
                    </div>

                    <!-- 校准时已用流量 -->
                    <div>
                        <label class="block text-sm font-medium text-slate-400 mb-2">校准时已用流量 (GB)</label>
                        <input type="number"
                               id="edit_traffic_calibration_value"
                               value="{{server.traffic_calibration_value|bytesToGB}}"
                               step="0.01"
                               class="w-full px-3 py-2 bg-slate-800/50 border border-slate-700 rounded-md text-slate-200 placeholder-slate-400"
                               placeholder="0">
                    </div>
                </div>
            </div>

            <!-- API设置 -->
            <div class="space-y-4">
                <h4 class="text-base font-medium text-slate-200">API 设置</h4>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-slate-400 mb-2">通讯密钥</label>
                        <input type="text"
                               id="edit_api_key"
                               value="{{server.data.api.key}}"
                               class="w-full px-3 py-2 bg-slate-800/50 border border-slate-700 rounded-md text-slate-200 placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-400 mb-2">API端口</label>
                        <input type="number"
                               id="edit_api_port"
                               value="{{server.data.api.port}}"
                               min="1"
                               max="65535"
                               class="w-full px-3 py-2 bg-slate-800/50 border border-slate-700 rounded-md text-slate-200 placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-400 mb-2">网络设备</label>
                        <input type="text"
                               id="edit_device"
                               value="{{server.data.device}}"
                               class="w-full px-3 py-2 bg-slate-800/50 border border-slate-700 rounded-md text-slate-200 placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                               placeholder="例如: eth0">
                    </div>
                </div>
            </div>

            <!-- 位置设置 -->
            <div class="space-y-4">
                <h4 class="text-base font-medium text-slate-200">位置设置</h4>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-slate-400 mb-2">手动设置国家</label>
                        <div class="flex items-center gap-3">
                            <div class="relative inline-block">
                                <input type="checkbox"
                                       id="edit_location_manual"
                                       class="sr-only"
                                       {% if server.data.location.manual %}
                                       checked
                                       {% endif %}>
                                <div onclick="toggleLocationManual()"
                                     class="w-11 h-6 bg-slate-700 rounded-full cursor-pointer transition-colors relative">
                                    <div id="location-manual-toggle"
                                         class="w-5 h-5 rounded-full bg-white absolute left-0.5 top-0.5 transition-transform duration-200 transform
                                         {% if server.data.location.manual %}
                                         translate-x-5 bg-purple-500
                                         {% endif %}">
                                    </div>
                                </div>
                            </div>
                            <span class="text-sm text-slate-400">启用手动设置</span>
                        </div>
                    </div>

                    <!-- 手动获取位置信息按钮 -->
                    <div>
                        <label class="block text-sm font-medium text-slate-400 mb-2">获取位置信息</label>
                        <div id="fetch-location-container" class="{% if server.data.location.manual %}hidden{% endif %}">
                            <button type="button"
                                  id="fetch-location-button"
                                  onclick="fetchLocationInfo()"
                                  class="flex items-center gap-2 px-4 py-2 bg-purple-500 hover:bg-purple-600 text-white rounded-md transition-colors">
                                <i class="material-icons text-base">location_on</i>
                                <span>手动获取位置</span>
                            </button>
                            <div id="location-status" class="mt-2 text-sm text-slate-400 hidden"></div>
                        </div>
                    </div>

                    <div id="country-select-container" class="{% if not server.data.location.manual %}hidden{% endif %}">
                        <label class="block text-sm font-medium text-slate-400 mb-2">国家/地区</label>

                        <!-- 隐藏的选择器，用于存储选中的国家代码 -->
                        <input type="hidden" id="edit_location_country_code" value="{% if server.data.location.code %}{{ server.data.location.code }}{% else %}OT{% endif %}">

                        <!-- 搜索输入框 -->
                        <div class="relative mb-2">
                            <input type="text"
                                   id="country-search"
                                   placeholder="输入国家代码或名称搜索..."
                                   class="w-full px-3 py-2 bg-slate-800/50 border border-slate-700 rounded-md text-slate-200 placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                            <div class="absolute inset-y-0 right-0 flex items-center pr-3">
                                <i class="material-icons text-slate-400">search</i>
                            </div>
                        </div>

                        <!-- 当前选中的国家显示 -->
                        <div id="selected-country" class="flex items-center gap-2 p-2 bg-slate-800 rounded-md mb-2">
                            <div id="selected-country-flag" class="w-8 h-6 flex-shrink-0 overflow-hidden rounded-sm border border-slate-700"></div>
                            <div id="selected-country-name" class="text-slate-200 flex-grow"></div>
                            <div id="selected-country-code" class="text-slate-400 text-sm"></div>
                        </div>

                        <!-- 国家列表容器 -->
                        <div id="country-list-container" class="max-h-60 overflow-y-auto bg-slate-800/50 border border-slate-700 rounded-md hidden">
                            <div id="country-list" class="grid grid-cols-2 gap-1 p-2">
                                <!-- 国家列表将通过JavaScript动态生成 -->
                            </div>
                        </div>

                        <!-- 特殊选项 -->
                        <div class="flex flex-wrap gap-2 mt-2">
                            <div class="country-option cursor-pointer flex items-center gap-2 p-2 bg-slate-800 rounded-md hover:bg-slate-700" data-code="LO">
                                <i class="material-icons text-slate-200">home</i>
                                <span class="text-slate-200">本地网络</span>
                                <span class="text-slate-400 text-sm">LO</span>
                            </div>
                            <div class="country-option cursor-pointer flex items-center gap-2 p-2 bg-slate-800 rounded-md hover:bg-slate-700" data-code="OT">
                                <i class="material-icons text-slate-200">public</i>
                                <span class="text-slate-200">其他地区</span>
                                <span class="text-slate-400 text-sm">OT</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 探针管理 -->
            <div class="space-y-4">
                <h4 class="text-base font-medium text-slate-200">探针管理</h4>
                <div class="flex items-center gap-3">
                    <button onclick="init()"
                            class="flex items-center gap-2 px-4 py-2 text-sm font-medium text-white bg-purple-500 hover:bg-purple-600 rounded-md transition-colors">
                        <i class="material-icons text-[18px]">download</i>
                        <span>安装探针</span>
                    </button>
                    <button onclick="update()"
                            class="flex items-center gap-2 px-4 py-2 text-sm font-medium text-white bg-green-500 hover:bg-green-600 rounded-md transition-colors">
                        <i class="material-icons text-[18px]">system_update</i>
                        <span>更新探针</span>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 安装进度弹窗 -->
<div id="install-progress-modal" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm z-50">
    <div class="flex items-center justify-center h-full w-full">
    <div class="bg-slate-900 rounded-lg p-6 max-w-xl w-full mx-4 border border-slate-800/50">
        <div class="text-center">
            <div class="animate-spin rounded-full h-12 w-12 border-4 border-purple-500 border-t-transparent mx-auto mb-4"></div>
            <h3 class="text-lg font-medium text-white mb-2">系统安装中</h3>
            <p id="install-status" class="text-sm text-slate-400 mb-4">正在安装系统组件...</p>

            <!-- 安装日志区域 -->
            <div id="install-log-container" class="mt-4 mb-4 max-h-60 overflow-y-auto text-left">
                <pre id="install-log" class="text-xs text-slate-300 bg-slate-800/50 p-3 rounded-md whitespace-pre-wrap"></pre>
            </div>

            <div class="text-xs text-slate-500">安装过程可能需要几分钟，请耐心等待</div>
        </div>
    </div>
    </div>
</div>
{% endblock %}

{%block js%}
<!-- 引入流量转换工具 -->
<script>
/**
 * 流量格式化工具函数
 */
window.TrafficFormat = {
    /**
     * 将字节数转换为GB
     * @param {number} bytes 字节数
     * @returns {number} GB值,保留2位小数
     */
    bytesToGB(bytes) {
        if (!bytes) return 0;

        // 使用安全的方式处理大数值
        try {
            const value = Number(bytes);
            if (isNaN(value) || !isFinite(value)) return 0;

            // 1GB = 1024^3 bytes
            const result = value / (1024 * 1024 * 1024);
            return parseFloat(result.toFixed(2));
        } catch (e) {
            console.error('[TrafficFormat] 字节转GB失败:', e);
            return 0;
        }
    },

    /**
     * 将GB转换为字节数
     * @param {number} gb GB值
     * @returns {number} 字节数
     */
    gbToBytes(gb) {
        if (!gb) return 0;
        try {
            const value = Number(gb);
            if (isNaN(value) || !isFinite(value)) return 0;

            // 处理非常大的值
            if (value > Number.MAX_SAFE_INTEGER / (1024 * 1024 * 1024)) {
                console.warn('[TrafficFormat] GB值过大，可能导致精度丢失');
            }

            // 1GB = 1024^3 bytes
            return Math.floor(value * 1024 * 1024 * 1024);
        } catch (e) {
            console.error('[TrafficFormat] GB转字节失败:', e);
            return 0;
        }
    },

    /**
     * 格式化流量数值为可读字符串
     * @param {number} bytes 字节数
     * @returns {string} 格式化后的字符串
     */
    formatBytes(bytes) {
        if (bytes === null || bytes === undefined || isNaN(bytes)) {
            return '0 B';
        }

        try {
            let value = Number(bytes);
            if (!isFinite(value)) {
                return '0 B';
            }

            const units = ['B', 'KB', 'MB', 'GB', 'TB', 'PB', 'EB', 'ZB'];
            const k = 1024;

            if (value === 0) return '0 B';

            // 使用对数计算来确定合适的单位级别
            const i = Math.floor(Math.log(Math.abs(value)) / Math.log(k));
            const unitIndex = Math.min(i, units.length - 1);

            value = value / Math.pow(k, unitIndex);

            // 根据数值大小和单位级别决定小数位数
            let decimals = 2;
            if (unitIndex >= 4) decimals = 2; // TB及以上保留2位小数
            else if (value >= 100) decimals = 1;
            else if (value >= 10) decimals = 2;
            else decimals = 3;

            return value.toFixed(decimals) + ' ' + units[unitIndex];
        } catch (e) {
            console.error('[TrafficFormat] 格式化字节失败:', e);
            return '0 B';
        }
    },

    /**
     * 格式化GB值为可读字符串
     * @param {number} gb GB值
     * @returns {string} 格式化后的字符串
     */
    formatGB(gb) {
        return this.formatBytes(this.gbToBytes(gb));
    }
};
</script>
<script>
// 工具函数
function timestampToDate(timestamp) {
    if (!timestamp) return '';
    const date = new Date(timestamp * 1000);
    return date.toISOString().split('T')[0];
}

// 切换手动设置国家的UI显示
function toggleLocationManual() {
    const checkbox = document.getElementById('edit_location_manual');
    const toggle = document.getElementById('location-manual-toggle');
    const container = document.getElementById('country-select-container');
    const fetchContainer = document.getElementById('fetch-location-container');

    // 切换复选框状态
    checkbox.checked = !checkbox.checked;

    // 更新开关样式
    if (checkbox.checked) {
        toggle.classList.add('translate-x-5', 'bg-purple-500');
        container.classList.remove('hidden');
        fetchContainer.classList.add('hidden');
    } else {
        toggle.classList.remove('translate-x-5', 'bg-purple-500');
        container.classList.add('hidden');
        fetchContainer.classList.remove('hidden');
    }
}

/**
 * 手动获取服务器位置信息
 */
async function fetchLocationInfo() {
    try {
        const button = document.getElementById('fetch-location-button');
        const statusDiv = document.getElementById('location-status');

        // 显示加载状态
        button.disabled = true;
        button.innerHTML = '<i class="material-icons animate-spin text-base">refresh</i> <span>正在获取...</span>';
        statusDiv.textContent = '正在获取位置信息...';
        statusDiv.classList.remove('hidden', 'text-red-500', 'text-green-500');
        statusDiv.classList.add('text-purple-400');

        // 获取服务器ID
        const serverId = window.location.pathname.split('/').filter(Boolean).pop();

        // 发送请求到服务器
        const response = await fetch(`/api/admin/servers/${serverId}/fetch-location`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        });

        const data = await response.json();
        console.log('位置信息更新响应:', data);

        if (data.success) {
            // 获取国家代码和国家名称的映射
            const countryMap = {
                'CN': '中国',
                'HK': '香港',
                'TW': '台湾',
                'JP': '日本',
                'KR': '韩国',
                'SG': '新加坡',
                'US': '美国',
                'CA': '加拿大',
                'UK': '英国',
                'DE': '德国',
                'FR': '法国',
                'AU': '澳大利亚',
                'RU': '俄罗斯',
                'UA': '乌克兰',
                'BR': '巴西',
                'IN': '印度',
                'ZA': '南非',
                'LO': '本地网络',
                'OT': '其他地区'
            };

            // 获取国家名称和地区信息
            const location = data.location || {};
            const countryCode = location.code || 'Unknown';
            const countryName = location.name_zh || countryMap[countryCode] || countryCode;
            const region = location.region || location.country?.region || '';

            // 构建位置显示文本
            const locationText = region ? `${countryName} - ${region}` : countryName;

            // 构建提示消息
            let message = '';
            if (data.unchanged) {
                message = `当前位置为 ${locationText} (${countryCode})，位置信息未发生变化`;
            } else {
                const previous = location.previous;
                if (previous) {
                    const prevCode = previous.code || 'Unknown';
                    const prevName = previous.name_zh || countryMap[prevCode] || prevCode;
                    const prevRegion = previous.region || previous.country?.region || '';
                    const prevLocationText = prevRegion ? `${prevName} - ${prevRegion}` : prevName;

                    message = `位置信息已更新：${prevLocationText} (${prevCode}) → ${locationText} (${countryCode})`;
                } else {
                    message = `位置信息已更新：${locationText} (${countryCode})`;
                }
            }

            statusDiv.textContent = message;
            statusDiv.classList.remove('text-purple-400', 'text-red-500');
            statusDiv.classList.add('text-green-500');

            // 如果位置信息有更新，3秒后刷新页面
            if (!data.unchanged) {
                setTimeout(() => {
                    window.location.reload();
                }, 3000);
            }
        } else {
            // 更新失败
            const errorMessage = data.message || data.error || '获取位置信息失败';
            console.error('位置信息更新失败:', errorMessage);
            throw new Error(errorMessage);
        }
    } catch (error) {
        const statusDiv = document.getElementById('location-status');

        // 显示错误信息
        statusDiv.textContent = error.message || '获取位置信息失败';
        statusDiv.classList.remove('hidden', 'text-purple-400');
        statusDiv.classList.add('text-red-500');
        console.error('获取位置信息失败:', error);
    } finally {
        // 恢复按钮状态
        const button = document.getElementById('fetch-location-button');
        setTimeout(() => {
            button.disabled = false;
            button.innerHTML = '<i class="material-icons text-base">location_on</i> <span>手动获取位置</span>';
        }, 1000);

        // 确保状态信息可见
        const statusDiv = document.getElementById('location-status');
        statusDiv.classList.remove('hidden');
    }
}

function dateStringToTimestamp(dateString) {
    if (!dateString) return 0;
    const date = new Date(dateString);
    return Math.floor(date.getTime() / 1000);
}

// 初始化表单数据
function initForm(server) {
    console.log('初始化服务器数据:', server);

    // 基本信息
    document.getElementById('sid').value = server.sid;
    document.getElementById('edit_name').value = server.name;
    document.getElementById('edit_status').value = server.status;
    document.getElementById('edit_top').value = server.top;
    if (server.expire_time) {
        document.getElementById('edit_expire_time').value = timestampToDate(server.expire_time);
    }

    // SSH设置
    document.getElementById('edit_ssh_host').value = server.data.ssh.host;
    document.getElementById('edit_ssh_port').value = server.data.ssh.port || '';
    document.getElementById('edit_ssh_username').value = server.data.ssh.username || '';
    document.getElementById('edit_ssh_password').value = server.data.ssh.password || '';
    document.getElementById('edit_ssh_pri').value = server.data.ssh.privateKey || '';

    // 设备和API设置
    document.getElementById('edit_device').value = server.data.device || '';
    document.getElementById('edit_api_key').value = server.data.api?.key || '';
    document.getElementById('edit_api_port').value = server.data.api?.port || '';

    // 流量设置
    document.getElementById('edit_traffic_limit').value = TrafficFormat.bytesToGB(server.traffic_limit);
    document.getElementById('edit_traffic_reset_day').value = server.traffic_reset_day || 1;
    document.getElementById('edit_traffic_alert_percent').value = server.traffic_alert_percent || 80;
    document.getElementById('edit_traffic_calibration_date').value = timestampToDate(server.traffic_calibration_date);
    document.getElementById('edit_traffic_calibration_value').value = TrafficFormat.bytesToGB(server.traffic_calibration_value);
}

// 编辑服务器
async function edit() {
    try {
        startloading();

        // 基础数据验证
        const name = V('edit_name');
        const host = V('edit_ssh_host');

        if (!name || !host) {
            notice('服务器名称和IP地址不能为空', 'error');
            return;
        }

        // 构造服务器配置数据 - 不检查SSH凭据，允许无凭据保存
        const serverData = {
            ssh: {
                host: host,
                port: parseInt(V('edit_ssh_port')) || 22,
                username: V('edit_ssh_username'),
                password: V('edit_ssh_password'),
                pri: V('edit_ssh_pri')
            },
            api: {
                key: V('edit_api_key') || '',
                port: parseInt(V('edit_api_port')) || 8080
            },
            device: V('edit_device') || ''
        };

        // 添加位置信息
        const isManualLocation = document.getElementById('edit_location_manual').checked;
        if (isManualLocation) {
            // 获取选择的国家代码
            const countryCode = V('edit_location_country_code');

            // 获取国家名称
            const countryNameElement = document.getElementById('selected-country-name');
            const countryName = countryNameElement ? countryNameElement.textContent.trim() : countryCode;

            // 构造国旗URL（使用本地SVG文件）
            let flagUrl = null;
            if (countryCode === 'LO') {
                // 本地网络使用null，表示使用图标字体
                flagUrl = null;
            } else if (countryCode === 'OT') {
                // 其他网络使用null，表示使用图标字体
                flagUrl = null;
            } else if (countryCode === 'UK') {
                // 英国使用GB代码
                flagUrl = '/img/flags/GB.SVG';
            } else {
                // 其他国家使用国家代码
                flagUrl = `/img/flags/${countryCode}.SVG`;
            }

            // 添加到服务器数据中 - 使用新的数据结构
            serverData.location = {
                code: countryCode,           // 国家代码，用于显示（如CN, US）
                flag: flagUrl,               // 国旗URL
                country_name: countryName,   // 国家名称
                name_zh: countryName,        // 国家中文名称
                manual: true,                // 标记为手动设置
                updated_at: Date.now()        // 更新时间戳
            };

            console.log('位置信息:', serverData.location);
        }

        // 构造请求数据
        const requestData = {
            name,
            data: JSON.stringify(serverData),
            status: parseInt(V('edit_status')),
            top: parseInt(V('edit_top')) || 0,
            expire_time: V('edit_expire_time') ?
                Math.floor(new Date(V('edit_expire_time') + ' 23:59:59').getTime() / 1000) :
                null,
            group_id: V('edit_group_id') || 'default',
            traffic_limit: TrafficFormat.gbToBytes(V('edit_traffic_limit')),
            traffic_reset_day: parseInt(V('edit_traffic_reset_day')) || 1,
            traffic_alert_percent: parseInt(V('edit_traffic_alert_percent')) || 80,
            traffic_calibration_date: V('edit_traffic_calibration_date') ?
                Math.floor(new Date(V('edit_traffic_calibration_date')).getTime() / 1000) :
                null,
            traffic_calibration_value: TrafficFormat.gbToBytes(V('edit_traffic_calibration_value'))
        };

        console.log('提交的数据:', requestData);

        const sid = V('sid');
        const res = await postjson(`/admin/servers/${sid}/edit`, requestData);

        if (res.status) {
            notice('保存成功', 'success');
            // 保持在当前页面，不再跳转
        } else {
            notice(res.data || '保存失败，请检查必填项', 'error');
        }
    } catch (error) {
        console.error('保存失败:', error);
        // 优化错误提示
        if (error.message && error.message.includes('handleInstallation')) {
            notice('保存成功，但自动安装失败。您可以稍后手动安装。', 'info');
        } else {
            notice('保存失败: ' + (error.message || '发生未知错误'), 'error');
        }
    } finally {
        endloading();
    }
}

// 删除服务器
async function del() {
    if (!confirm('确定要删除该服务器吗？此操作不可恢复！')) {
        return;
    }

    try {
        startloading();
        const sid = V('sid');
        const res = await postjson(`/admin/servers/${sid}/del`);

        if (res.status) {
            notice('删除成功', 'success');
            setTimeout(() => location.href = '/admin/servers', 1000);
        } else {
            notice(res.data || '删除失败', 'error');
        }
    } catch (error) {
        console.error('删除失败:', error);
        notice('删除失败: ' + (error.message || '未知错误'), 'error');
    } finally {
        endloading();
    }
}

// 显示提示消息
function showToast(message, type = 'info') {
    const toast = document.createElement('div');
    toast.className = `fixed top-4 right-4 p-4 rounded-lg shadow-lg z-50 ${
        type === 'error' ? 'bg-red-500' :
        type === 'success' ? 'bg-green-500' :
        'bg-purple-500'
    } text-white`;
    toast.textContent = message;

    document.body.appendChild(toast);

    setTimeout(() => {
        toast.classList.add('opacity-0', 'transition-opacity');
        setTimeout(() => toast.remove(), 300);
    }, 3000);
}
</script>

<script>
// 添加弹窗控制函数
function showInstallModal(title = '系统安装中', status = '正在安装系统组件...') {
    const modal = document.getElementById('install-progress-modal');
    if (modal) {
        modal.querySelector('h3').textContent = title;
        document.getElementById('install-status').textContent = status;
        document.getElementById('install-log').textContent = ''; // 清空日志
        modal.classList.remove('hidden');
    }
}

function hideInstallModal() {
    const modal = document.getElementById('install-progress-modal');
    if (modal) {
        modal.classList.add('hidden');
    }
}

function updateInstallStatus(status) {
    const statusElement = document.getElementById('install-status');
    if (statusElement) {
        statusElement.textContent = status;
    }
}

function updateInstallLog(log) {
    const logElement = document.getElementById('install-log');
    if (logElement) {
        logElement.textContent = log;
        // 滚动到日志底部
        const container = document.getElementById('install-log-container');
        if (container) {
            container.scrollTop = container.scrollHeight;
        }
    }
}

// 修改现有的 init 函数
async function init() {
    if (!confirm('确认重新安装探针？这可能需要几分钟时间。')) {
        return;
    }

    showInstallModal('重新安装探针', '正在安装系统组件...');
    try {
        const sid = V('sid');
        const res = await postjson(`/admin/servers/${sid}/init`);

        // 如果有安装日志，显示安装日志
        if (res.log) {
            updateInstallLog(res.log);
        }

        if (res.status) {
            // 更新状态
            updateInstallStatus('安装成功！');

            // 显示成功通知
            notice('安装成功！', 'success');

            // 延时关闭弹窗，给用户时间查看日志
            setTimeout(() => {
                hideInstallModal();
            }, 3000);
        } else {
            // 更新状态
            updateInstallStatus('安装失败');

            // 显示错误日志
            if (res.log) {
                updateInstallLog(res.log);
            }

            // 延时关闭弹窗，给用户时间查看错误日志
            setTimeout(() => {
                const errorMsg = res.data || '未知错误';
                const retryInstall = confirm(`探针安装失败: ${errorMsg}\n\n是否重试安装？`);

                hideInstallModal();

                if (retryInstall) {
                    return init(); // 递归调用重试
                } else {
                    notice('探针安装失败', 'error');
                }
            }, 3000);
        }
    } catch (error) {
        console.error('安装失败:', error);

        // 更新状态
        updateInstallStatus('安装过程出错');

        // 显示错误日志
        updateInstallLog(`错误: ${error.message || '未知错误'}`);

        // 延时关闭弹窗，给用户时间查看错误日志
        setTimeout(() => {
            const retryInstall = confirm(`安装过程出错: ${error.message || '未知错误'}\n\n是否重试安装？`);

            hideInstallModal();

            if (retryInstall) {
                return init(); // 递归调用重试
            } else {
                notice('探针安装失败: ' + (error.message || '未知错误'), 'error');
            }
        }, 3000);
    }
}

// 修改现有的 update 函数
async function update() {
    if (!confirm('确认更新探针？这可能需要几分钟时间。')) {
        return;
    }

    showInstallModal('更新探针', '正在更新系统...');
    try {
        const sid = V('sid');
        const res = await postjson(`/admin/servers/${sid}/update`);

        if (res.status) {
            notice('更新成功！', 'success');
            setTimeout(() => {
                hideInstallModal();
            }, 1000);
        } else {
            hideInstallModal();
            const errorMsg = res.data || '未知错误';
            const retryUpdate = confirm(`探针更新失败: ${errorMsg}\n\n是否重试更新？`);

            if (retryUpdate) {
                return update(); // 递归调用重试
            } else {
                notice('探针更新失败', 'error');
            }
        }
    } catch (error) {
        console.error('更新失败:', error);
        hideInstallModal();

        const retryUpdate = confirm(`更新过程出错: ${error.message || '未知错误'}\n\n是否重试更新？`);
        if (retryUpdate) {
            return update(); // 递归调用重试
        } else {
            notice('探针更新失败: ' + (error.message || '未知错误'), 'error');
        }
    } finally {
        hideInstallModal();
    }
}

// 添加私钥文件处理函数
document.getElementById('edit_ssh_pri_file').addEventListener('change', function(event) {
    const file = event.target.files[0];
    if (!file) return;

    // 显示加载状态
    startloading();

    const reader = new FileReader();
    reader.onload = function(e) {
        const content = e.target.result;
        document.getElementById('edit_ssh_pri').value = content;
        endloading();
        notice('私钥文件已加载', 'success');
    };

    reader.onerror = function(e) {
        console.error('读取文件失败:', e);
        endloading();
        notice('读取文件失败', 'error');
    };

    reader.readAsText(file);
});

// 添加测试SSH连接函数
async function testSSHConnection() {
    try {
        // 显示加载状态，重置结果区域
        startloading();
        const resultEl = document.getElementById('ssh-test-result');
        resultEl.classList.add('hidden');
        resultEl.textContent = '';
        resultEl.classList.remove('text-green-500', 'text-red-500');

        // 基本验证
        const host = V('edit_ssh_host');
        if (!host) {
            notice('请输入服务器地址', 'error');
            return;
        }

        const username = V('edit_ssh_username') || 'root';
        const port = V('edit_ssh_port') || 22;
        const password = V('edit_ssh_password');
        const privateKey = V('edit_ssh_pri');
        const passphrase = V('edit_ssh_passphrase');

        if (!password && !privateKey) {
            notice('测试连接需要SSH密码或私钥，但您可以不提供这些信息也能保存服务器', 'info');
            endloading();
            return;
        }

        // 发送测试请求
        const response = await fetch('/admin/test-ssh', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                host,
                port,
                username,
                password,
                privateKey,
                passphrase
            })
        });

        const result = await response.json();

        // 显示结果
        resultEl.classList.remove('hidden');

        if (result.status) {
            notice('连接成功', 'success');
            resultEl.textContent = '✓ 连接成功';
            resultEl.classList.add('text-green-500');
        } else {
            notice(result.data || '连接失败', 'error');
            resultEl.textContent = '✗ ' + (result.data || '连接失败');
            resultEl.classList.add('text-red-500');

            // 如果有详细错误信息，添加到结果中
            if (result.details) {
                console.error('连接错误详情:', result.details);
            }

            // 检查是否是私钥密码问题
            if (result.data && result.data.includes('私钥解密失败') && privateKey && !passphrase) {
                resultEl.textContent += '，请尝试提供私钥密码';
            }
        }
    } catch (error) {
        console.error('测试SSH连接失败:', error);
        notice(error.message || '测试连接失败', 'error');

        // 显示错误到结果区域
        const resultEl = document.getElementById('ssh-test-result');
        resultEl.classList.remove('hidden');
        resultEl.textContent = '✗ 连接请求失败: ' + (error.message || '未知错误');
        resultEl.classList.add('text-red-500');
    } finally {
        endloading();
    }
}

// 添加密码显示/隐藏功能
document.querySelectorAll('.toggle-password').forEach(toggle => {
    toggle.addEventListener('click', function() {
        const input = this.parentElement.querySelector('input');
        const icon = this.querySelector('i');

        if (input.type === 'password') {
            input.type = 'text';
            icon.textContent = 'visibility_off';
        } else {
            input.type = 'password';
            icon.textContent = 'visibility';
        }
    });
});

// 检查URL中的锚点，如果是#install，则自动触发安装
document.addEventListener('DOMContentLoaded', function() {
    if (window.location.hash === '#install') {
        // 延时一下，确保页面已经加载完成
        setTimeout(() => {
            init();
            // 清除锚点，防止刷新页面时再次触发
            history.replaceState(null, null, window.location.pathname);
        }, 500);
    }
});

// 引入国家选择器JavaScript文件
document.write('<script src="/js/country-selector.js"><\/script>');
</script>
{% endblock %}
