{% set title = "ç¼–è¾‘æœåŠ¡å™¨" %}
{%set admin = true%}
{% extends "../../base.html" %}

{% block content %}
<!-- é¡µé¢å®¹å™¨ -->
<div class="container mx-auto px-2 sm:px-4 flex flex-col md:flex-row gap-3 md:gap-6 justify-center" style="padding-top: calc(1.5rem + env(safe-area-inset-top));">
    <!-- å¼•å…¥ä¾§è¾¹æ  -->
    {% include "../sidebar.html" %}

    <!-- ä¸»å†…å®¹åŒºåŸŸ -->
    <div class="flex-1 md:max-w-4xl bg-slate-900/80 backdrop-blur rounded-lg border border-slate-800/50 p-4 md:p-6">
        <!-- é¡µé¢æ ‡é¢˜ -->
        <div class="flex items-center justify-between mb-6">
            <div class="flex items-center gap-3">
                <i class="material-icons text-purple-500">edit</i>
                <div>
                    <h3 class="text-lg font-medium text-white">{{server.name}}</h3>
                    <p class="text-sm text-slate-400">ç¼–è¾‘æœåŠ¡å™¨</p>
                </div>
            </div>
            <!-- ä¸»è¦æ“ä½œæŒ‰é’®ï¼šä¿å­˜å’Œåˆ é™¤ -->
            <div class="flex items-center gap-2">
                <button onclick="edit()"
                        class="flex items-center gap-2 px-3 py-1.5 text-sm font-medium text-white bg-purple-500 hover:bg-purple-600 rounded-md transition-colors">
                    <i class="material-icons text-[18px]">save</i>
                    <span>ä¿å­˜</span>
                </button>
                <button onclick="del()"
                        class="flex items-center gap-2 px-3 py-1.5 text-sm font-medium text-white bg-red-500 hover:bg-red-600 rounded-md transition-colors">
                    <i class="material-icons text-[18px]">delete</i>
                    <span>åˆ é™¤</span>
                </button>
            </div>
        </div>

        <!-- éšè—å­—æ®µï¼šæœåŠ¡å™¨IDå’Œç½®é¡¶çŠ¶æ€ -->
        <input type="text" id='sid' value="{{server.sid}}" hidden>
        <input type="text" id='edit_top' value="{{server.top}}" hidden>

        <!-- è¡¨å•å†…å®¹åŒºåŸŸ -->
        <div class="space-y-6">
            <!-- åŸºæœ¬ä¿¡æ¯è®¾ç½® -->
            <div class="space-y-4">
                <h4 class="text-base font-medium text-slate-200">åŸºæœ¬ä¿¡æ¯</h4>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <!-- æœåŠ¡å™¨åç§° -->
                    <div>
                        <label class="block text-sm font-medium text-slate-400 mb-2">æœåŠ¡å™¨åç§°</label>
                        <input type="text"
                               id="edit_name"
                               value="{{server.name}}"
                               class="w-full px-3 py-2 bg-slate-800/50 border border-slate-700 rounded-md text-slate-200 placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                    </div>
                    <!-- æœåŠ¡å™¨çŠ¶æ€é€‰æ‹© -->
                    <div>
                        <label class="block text-sm font-medium text-slate-400 mb-2">çŠ¶æ€</label>
                        <select id="edit_status"
                                class="w-full px-3 py-2 bg-slate-800/50 border border-slate-700 rounded-md text-slate-200 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                            {% for sta in ['1', '2', '0'] %}
                            {% set names = {'1':'æ­£å¸¸','2':'å¯¹å¤–éšè—','0':'ä¸å¯ç”¨'} %}
                            <option value="{{sta}}" {% if sta==server.status %}selected{% endif %}>{{names[sta]}}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <!-- åˆ°æœŸæ—¶é—´ -->
                    <div>
                        <label class="block text-sm font-medium text-slate-400 mb-2">åˆ°æœŸæ—¶é—´</label>
                        <input type="date"
                               id="edit_expire_time"
                               value="{{server.expire_time|formatDate}}"
                               class="w-full px-3 py-2 bg-slate-800/50 border border-slate-700 rounded-md text-slate-200 placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                        <p class="mt-1 text-xs text-slate-500">ç•™ç©ºè¡¨ç¤ºæ°¸ä¹…æœ‰æ•ˆ</p>
                    </div>
                    <!-- æœåŠ¡å™¨åˆ†ç»„ -->
                    <div>
                        <label class="block text-sm font-medium text-slate-400 mb-2">æœåŠ¡å™¨åˆ†ç»„</label>
                        <select id="edit_group_id"
                                class="w-full px-3 py-2 bg-slate-800/50 border border-slate-700 rounded-md text-slate-200 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                            {% for group in groups %}
                            <option value="{{group.id}}" {% if group.id == server.group_id %}selected{% endif %}>{{group.name}}</option>
                            {% endfor %}
                            {% if not groups or groups.length == 0 %}
                            <option value="default" {% if server.group_id == 'default' %}selected{% endif %}>é»˜è®¤åˆ†ç»„</option>
                            {% endif %}
                        </select>
                    </div>
                </div>
            </div>

            <!-- SSHè¿æ¥è®¾ç½® -->
            <div class="space-y-4">
                <h4 class="text-base font-medium text-slate-200">SSH è®¾ç½®</h4>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <!-- SSHè¿æ¥å‚æ•°ï¼šä¸»æœºã€ç«¯å£ã€ç”¨æˆ·å -->
                    <div>
                        <label class="block text-sm font-medium text-slate-400 mb-2">åŸŸå/IP</label>
                        <input type="text"
                               id="edit_ssh_host"
                               value="{{server.data.ssh.host}}"
                               placeholder="IPv4æˆ–IPv6åœ°å€ï¼Œå¦‚: 192.168.1.1 æˆ– 2001:db8::1"
                               class="w-full px-3 py-2 bg-slate-800/50 border border-slate-700 rounded-md text-slate-200 placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                        <p class="mt-1 text-xs text-slate-500">æ”¯æŒIPv4å’ŒIPv6åœ°å€ï¼ŒIPv6åœ°å€æ— éœ€æ·»åŠ æ–¹æ‹¬å·</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-400 mb-2">ç«¯å£</label>
                        <input type="number"
                               id="edit_ssh_port"
                               value="{{server.data.ssh.port}}"
                               class="w-full px-3 py-2 bg-slate-800/50 border border-slate-700 rounded-md text-slate-200 placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-400 mb-2">ç”¨æˆ·å</label>
                        <input type="text"
                               id="edit_ssh_username"
                               value="{{server.data.ssh.username}}"
                               class="w-full px-3 py-2 bg-slate-800/50 border border-slate-700 rounded-md text-slate-200 placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-400 mb-2">å¯†ç  (å¯é€‰)</label>
                        <div class="relative">
                            <input type="password"
                                   id="edit_ssh_password"
                                   value="{{server.data.ssh.password}}"
                                   class="w-full px-3 py-2 bg-slate-800/50 border border-slate-700 rounded-md text-slate-200 placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                            <span class="absolute inset-y-0 right-0 flex items-center pr-3 cursor-pointer toggle-password">
                                <i class="material-icons text-slate-500">visibility</i>
                            </span>
                        </div>
                    </div>

                    <!-- ä¿®æ”¹ä¸ºè·¨ä¸‰æ ¼çš„ç§é’¥è®¾ç½®åŒºåŸŸ -->
                    <div class="md:col-span-2 lg:col-span-3">
                        <div class="bg-slate-800/30 p-4 rounded-lg space-y-3">
                            <label class="block text-sm font-medium text-slate-400">ç§é’¥ (å¯é€‰)</label>
                            <div class="relative">
                                <input type="password"
                                       id="edit_ssh_pri"
                                       value="{{server.data.ssh.pri}}"
                                       class="w-full px-3 py-2 bg-slate-800/50 border border-slate-700 rounded-md text-slate-200 placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                                <span class="absolute inset-y-0 right-0 flex items-center pr-3 cursor-pointer toggle-password">
                                    <i class="material-icons text-slate-500">visibility</i>
                                </span>
                            </div>

                            <!-- æ–°å¢ï¼šç§é’¥å¯†ç å­—æ®µ -->
                            <div>
                                <label class="block text-sm font-medium text-slate-400 mb-2">ç§é’¥å¯†ç  (å¦‚æœæœ‰)</label>
                                <input type="password"
                                       id="edit_ssh_passphrase"
                                       placeholder="å¦‚æœç§é’¥æœ‰å¯†ç ä¿æŠ¤ï¼Œè¯·åœ¨æ­¤è¾“å…¥"
                                       class="w-full px-3 py-2 bg-slate-800/50 border border-slate-700 rounded-md text-slate-200 placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                            </div>

                            <div class="mt-3">
                                <p class="text-xs text-slate-500 mb-2">æ”¯æŒ RSAã€ED25519 å’Œ PKCS8 æ ¼å¼çš„ç§é’¥</p>
                                <div class="flex items-center space-x-2">
                                    <input type="file"
                                           id="edit_ssh_pri_file"
                                           class="hidden"
                                           accept=".pem,.key,.ppk">
                                    <button type="button"
                                            onclick="document.getElementById('edit_ssh_pri_file').click()"
                                            class="px-3 py-1 text-xs bg-slate-700 hover:bg-slate-600 text-white rounded">
                                        <i class="material-icons text-[14px] align-text-bottom">upload_file</i>
                                        ä¸Šä¼ ç§é’¥æ–‡ä»¶
                                    </button>
                                    <button type="button"
                                            onclick="testSSHConnection()"
                                            class="px-3 py-1 text-xs bg-blue-500 hover:bg-blue-600 text-white rounded">
                                        <i class="material-icons text-[14px] align-text-bottom">check_circle</i>
                                        æµ‹è¯•è¿æ¥
                                    </button>
                                </div>
                                <!-- è¿æ¥ç»“æœ -->
                                <div id="ssh-test-result" class="mt-2 text-sm hidden"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- æµé‡è®¾ç½® -->
            <div class="space-y-4">
                <h4 class="text-base font-medium text-slate-200">æµé‡è®¾ç½®</h4>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <!-- æ¯æœˆæµé‡é™åˆ¶ -->
                    <div>
                        <label class="block text-sm font-medium text-slate-400 mb-2">æ¯æœˆæµé‡é™åˆ¶ (GB)</label>
                        <input type="number"
                               id="edit_traffic_limit"
                               value="{{server.traffic_limit|bytesToGB}}"
                               class="w-full px-3 py-2 bg-slate-800/50 border border-slate-700 rounded-md text-slate-200 placeholder-slate-400"
                               placeholder="0">
                    </div>

                    <!-- æµé‡é‡ç½®æ—¥ -->
                    <div>
                        <label class="block text-sm font-medium text-slate-400 mb-2">æµé‡é‡ç½®æ—¥</label>
                        <input type="number"
                               id="edit_traffic_reset_day"
                               value="{{server.traffic_reset_day|default(1)}}"
                               min="1"
                               max="31"
                               class="w-full px-3 py-2 bg-slate-800/50 border border-slate-700 rounded-md text-slate-200 placeholder-slate-400"
                               placeholder="1">
                    </div>

                    <!-- æµé‡é¢„è­¦é˜ˆå€¼ -->
                    <div>
                        <label class="block text-sm font-medium text-slate-400 mb-2">æµé‡é¢„è­¦é˜ˆå€¼ (%)</label>
                        <input type="number"
                               id="edit_traffic_alert_percent"
                               value="{{server.traffic_alert_percent|default(80)}}"
                               min="0"
                               max="100"
                               class="w-full px-3 py-2 bg-slate-800/50 border border-slate-700 rounded-md text-slate-200 placeholder-slate-400"
                               placeholder="80">
                    </div>

                    <!-- æµé‡æ ¡å‡†æ—¥æœŸ -->
                    <div>
                        <label class="block text-sm font-medium text-slate-400 mb-2">æµé‡æ ¡å‡†æ—¥æœŸ</label>
                        <input type="date"
                               id="edit_traffic_calibration_date"
                               value="{{server.traffic_calibration_date|formatDate}}"
                               class="w-full px-3 py-2 bg-slate-800/50 border border-slate-700 rounded-md text-slate-200 placeholder-slate-400">
                    </div>

                    <!-- æ ¡å‡†æ—¶å·²ç”¨æµé‡ -->
                    <div>
                        <label class="block text-sm font-medium text-slate-400 mb-2">æ ¡å‡†æ—¶å·²ç”¨æµé‡ (GB)</label>
                        <input type="number"
                               id="edit_traffic_calibration_value"
                               value="{{server.traffic_calibration_value|bytesToGB}}"
                               step="0.01"
                               class="w-full px-3 py-2 bg-slate-800/50 border border-slate-700 rounded-md text-slate-200 placeholder-slate-400"
                               placeholder="0">
                    </div>
                </div>
            </div>

            <!-- APIè®¾ç½® -->
            <div class="space-y-4">
                <h4 class="text-base font-medium text-slate-200">API è®¾ç½®</h4>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-slate-400 mb-2">é€šè®¯å¯†é’¥</label>
                        <input type="text"
                               id="edit_api_key"
                               value="{{server.data.api.key}}"
                               class="w-full px-3 py-2 bg-slate-800/50 border border-slate-700 rounded-md text-slate-200 placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-400 mb-2">APIç«¯å£</label>
                        <input type="number"
                               id="edit_api_port"
                               value="{{server.data.api.port}}"
                               min="1"
                               max="65535"
                               class="w-full px-3 py-2 bg-slate-800/50 border border-slate-700 rounded-md text-slate-200 placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-400 mb-2">ç½‘ç»œè®¾å¤‡</label>
                        <input type="text"
                               id="edit_device"
                               value="{{server.data.device}}"
                               class="w-full px-3 py-2 bg-slate-800/50 border border-slate-700 rounded-md text-slate-200 placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                               placeholder="ä¾‹å¦‚: eth0">
                    </div>
                </div>
            </div>

            <!-- ä½ç½®è®¾ç½® -->
            <div class="space-y-4">
                <h4 class="text-base font-medium text-slate-200">ä½ç½®è®¾ç½®</h4>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-slate-400 mb-2">æ‰‹åŠ¨è®¾ç½®å›½å®¶</label>
                        <div class="flex items-center gap-3">
                            <div class="relative inline-block">
                                <input type="checkbox"
                                       id="edit_location_manual"
                                       class="sr-only"
                                       {% if server.data.location.country.manual %}
                                       checked
                                       {% endif %}>
                                <div onclick="toggleLocationManual()"
                                     class="w-11 h-6 bg-slate-700 rounded-full cursor-pointer transition-colors relative">
                                    <div id="location-manual-toggle"
                                         class="w-5 h-5 rounded-full bg-white absolute left-0.5 top-0.5 transition-transform duration-200 transform
                                         {% if server.data.location.country.manual %}
                                         translate-x-5 bg-purple-500
                                         {% endif %}">
                                    </div>
                                </div>
                            </div>
                            <span class="text-sm text-slate-400">å¯ç”¨æ‰‹åŠ¨è®¾ç½®</span>
                        </div>
                    </div>

                    <!-- æ‰‹åŠ¨è·å–ä½ç½®ä¿¡æ¯æŒ‰é’® -->
                    <div>
                        <label class="block text-sm font-medium text-slate-400 mb-2">è·å–ä½ç½®ä¿¡æ¯</label>
                        <div id="fetch-location-container" class="{% if server.data.location.country.manual %}hidden{% endif %}">
                            <button type="button"
                                  id="fetch-location-button"
                                  onclick="fetchLocationInfo()"
                                  class="flex items-center gap-2 px-4 py-2 bg-purple-500 hover:bg-purple-600 text-white rounded-md transition-colors">
                                <i class="material-icons text-base">location_on</i>
                                <span>æ‰‹åŠ¨è·å–ä½ç½®</span>
                            </button>
                            <div id="location-status" class="mt-2 text-sm text-slate-400 hidden"></div>
                        </div>
                    </div>

                    <div id="country-select-container" class="{% if not server.data.location.country.manual %}hidden{% endif %}">
                        <label class="block text-sm font-medium text-slate-400 mb-2">å›½å®¶/åœ°åŒº</label>
                        <select id="edit_location_country_code"
                                class="w-full px-3 py-2 bg-slate-800/50 border border-slate-700 rounded-md text-slate-200 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                            <option value="CN" {% if server.data.location.country.code == 'CN' %}selected{% endif %}>ğŸ‡¨ğŸ‡³ ä¸­å›½ (CN)</option>
                            <option value="HK" {% if server.data.location.country.code == 'HK' %}selected{% endif %}>ğŸ‡­ğŸ‡° é¦™æ¸¯ (HK)</option>
                            <option value="TW" {% if server.data.location.country.code == 'TW' %}selected{% endif %}>ğŸ‡¹ğŸ‡¼ å°æ¹¾ (TW)</option>
                            <option value="JP" {% if server.data.location.country.code == 'JP' %}selected{% endif %}>ğŸ‡¯ğŸ‡µ æ—¥æœ¬ (JP)</option>
                            <option value="KR" {% if server.data.location.country.code == 'KR' %}selected{% endif %}>ğŸ‡°ğŸ‡· éŸ©å›½ (KR)</option>
                            <option value="SG" {% if server.data.location.country.code == 'SG' %}selected{% endif %}>ğŸ‡¸ğŸ‡¬ æ–°åŠ å¡ (SG)</option>
                            <option value="US" {% if server.data.location.country.code == 'US' %}selected{% endif %}>ğŸ‡ºğŸ‡¸ ç¾å›½ (US)</option>
                            <option value="CA" {% if server.data.location.country.code == 'CA' %}selected{% endif %}>ğŸ‡¨ğŸ‡¦ åŠ æ‹¿å¤§ (CA)</option>
                            <option value="UK" {% if server.data.location.country.code == 'UK' %}selected{% endif %}>ğŸ‡¬ğŸ‡§ è‹±å›½ (UK)</option>
                            <option value="DE" {% if server.data.location.country.code == 'DE' %}selected{% endif %}>ğŸ‡©ğŸ‡ª å¾·å›½ (DE)</option>
                            <option value="FR" {% if server.data.location.country.code == 'FR' %}selected{% endif %}>ğŸ‡«ğŸ‡· æ³•å›½ (FR)</option>
                            <option value="AU" {% if server.data.location.country.code == 'AU' %}selected{% endif %}>ğŸ‡¦ğŸ‡º æ¾³å¤§åˆ©äºš (AU)</option>
                            <option value="RU" {% if server.data.location.country.code == 'RU' %}selected{% endif %}>ğŸ‡·ğŸ‡º ä¿„ç½—æ–¯ (RU)</option>
                            <option value="UA" {% if server.data.location.country.code == 'UA' %}selected{% endif %}>ğŸ‡ºğŸ‡¦ ä¹Œå…‹å…° (UA)</option>
                            <option value="BR" {% if server.data.location.country.code == 'BR' %}selected{% endif %}>ğŸ‡§ğŸ‡· å·´è¥¿ (BR)</option>
                            <option value="IN" {% if server.data.location.country.code == 'IN' %}selected{% endif %}>ğŸ‡®ğŸ‡³ å°åº¦ (IN)</option>
                            <option value="ZA" {% if server.data.location.country.code == 'ZA' %}selected{% endif %}>ğŸ‡¿ğŸ‡¦ å—é (ZA)</option>
                            <option value="LO" {% if server.data.location.country.code == 'LO' %}selected{% endif %}>ğŸ  æœ¬åœ°ç½‘ç»œ (LO)</option>
                            <option value="OT" {% if server.data.location.country.code == 'OT' or not server.data.location.country.code %}selected{% endif %}>ğŸŒ å…¶ä»–åœ°åŒº (OT)</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- æ¢é’ˆç®¡ç† -->
            <div class="space-y-4">
                <h4 class="text-base font-medium text-slate-200">æ¢é’ˆç®¡ç†</h4>
                <div class="flex items-center gap-3">
                    <button onclick="init()"
                            class="flex items-center gap-2 px-4 py-2 text-sm font-medium text-white bg-purple-500 hover:bg-purple-600 rounded-md transition-colors">
                        <i class="material-icons text-[18px]">download</i>
                        <span>å®‰è£…æ¢é’ˆ</span>
                    </button>
                    <button onclick="update()"
                            class="flex items-center gap-2 px-4 py-2 text-sm font-medium text-white bg-green-500 hover:bg-green-600 rounded-md transition-colors">
                        <i class="material-icons text-[18px]">system_update</i>
                        <span>æ›´æ–°æ¢é’ˆ</span>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- å®‰è£…è¿›åº¦å¼¹çª— -->
<div id="install-progress-modal" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm z-50">
    <div class="flex items-center justify-center h-full w-full">
    <div class="bg-slate-900 rounded-lg p-6 max-w-xl w-full mx-4 border border-slate-800/50">
        <div class="text-center">
            <div class="animate-spin rounded-full h-12 w-12 border-4 border-purple-500 border-t-transparent mx-auto mb-4"></div>
            <h3 class="text-lg font-medium text-white mb-2">ç³»ç»Ÿå®‰è£…ä¸­</h3>
            <p id="install-status" class="text-sm text-slate-400 mb-4">æ­£åœ¨å®‰è£…ç³»ç»Ÿç»„ä»¶...</p>

            <!-- å®‰è£…æ—¥å¿—åŒºåŸŸ -->
            <div id="install-log-container" class="mt-4 mb-4 max-h-60 overflow-y-auto text-left">
                <pre id="install-log" class="text-xs text-slate-300 bg-slate-800/50 p-3 rounded-md whitespace-pre-wrap"></pre>
            </div>

            <div class="text-xs text-slate-500">å®‰è£…è¿‡ç¨‹å¯èƒ½éœ€è¦å‡ åˆ†é’Ÿï¼Œè¯·è€å¿ƒç­‰å¾…</div>
        </div>
    </div>
    </div>
</div>
{% endblock %}

{%block js%}
<!-- å¼•å…¥æµé‡è½¬æ¢å·¥å…· -->
<script>
/**
 * æµé‡æ ¼å¼åŒ–å·¥å…·å‡½æ•°
 */
window.TrafficFormat = {
    /**
     * å°†å­—èŠ‚æ•°è½¬æ¢ä¸ºGB
     * @param {number} bytes å­—èŠ‚æ•°
     * @returns {number} GBå€¼,ä¿ç•™2ä½å°æ•°
     */
    bytesToGB(bytes) {
        if (!bytes) return 0;

        // ä½¿ç”¨å®‰å…¨çš„æ–¹å¼å¤„ç†å¤§æ•°å€¼
        try {
            const value = Number(bytes);
            if (isNaN(value) || !isFinite(value)) return 0;

            // 1GB = 1024^3 bytes
            const result = value / (1024 * 1024 * 1024);
            return parseFloat(result.toFixed(2));
        } catch (e) {
            console.error('[TrafficFormat] å­—èŠ‚è½¬GBå¤±è´¥:', e);
            return 0;
        }
    },

    /**
     * å°†GBè½¬æ¢ä¸ºå­—èŠ‚æ•°
     * @param {number} gb GBå€¼
     * @returns {number} å­—èŠ‚æ•°
     */
    gbToBytes(gb) {
        if (!gb) return 0;
        try {
            const value = Number(gb);
            if (isNaN(value) || !isFinite(value)) return 0;

            // å¤„ç†éå¸¸å¤§çš„å€¼
            if (value > Number.MAX_SAFE_INTEGER / (1024 * 1024 * 1024)) {
                console.warn('[TrafficFormat] GBå€¼è¿‡å¤§ï¼Œå¯èƒ½å¯¼è‡´ç²¾åº¦ä¸¢å¤±');
            }

            // 1GB = 1024^3 bytes
            return Math.floor(value * 1024 * 1024 * 1024);
        } catch (e) {
            console.error('[TrafficFormat] GBè½¬å­—èŠ‚å¤±è´¥:', e);
            return 0;
        }
    },

    /**
     * æ ¼å¼åŒ–æµé‡æ•°å€¼ä¸ºå¯è¯»å­—ç¬¦ä¸²
     * @param {number} bytes å­—èŠ‚æ•°
     * @returns {string} æ ¼å¼åŒ–åçš„å­—ç¬¦ä¸²
     */
    formatBytes(bytes) {
        if (bytes === null || bytes === undefined || isNaN(bytes)) {
            return '0 B';
        }

        try {
            let value = Number(bytes);
            if (!isFinite(value)) {
                return '0 B';
            }

            const units = ['B', 'KB', 'MB', 'GB', 'TB', 'PB', 'EB', 'ZB'];
            const k = 1024;

            if (value === 0) return '0 B';

            // ä½¿ç”¨å¯¹æ•°è®¡ç®—æ¥ç¡®å®šåˆé€‚çš„å•ä½çº§åˆ«
            const i = Math.floor(Math.log(Math.abs(value)) / Math.log(k));
            const unitIndex = Math.min(i, units.length - 1);

            value = value / Math.pow(k, unitIndex);

            // æ ¹æ®æ•°å€¼å¤§å°å’Œå•ä½çº§åˆ«å†³å®šå°æ•°ä½æ•°
            let decimals = 2;
            if (unitIndex >= 4) decimals = 2; // TBåŠä»¥ä¸Šä¿ç•™2ä½å°æ•°
            else if (value >= 100) decimals = 1;
            else if (value >= 10) decimals = 2;
            else decimals = 3;

            return value.toFixed(decimals) + ' ' + units[unitIndex];
        } catch (e) {
            console.error('[TrafficFormat] æ ¼å¼åŒ–å­—èŠ‚å¤±è´¥:', e);
            return '0 B';
        }
    },

    /**
     * æ ¼å¼åŒ–GBå€¼ä¸ºå¯è¯»å­—ç¬¦ä¸²
     * @param {number} gb GBå€¼
     * @returns {string} æ ¼å¼åŒ–åçš„å­—ç¬¦ä¸²
     */
    formatGB(gb) {
        return this.formatBytes(this.gbToBytes(gb));
    }
};
</script>
<script>
// å·¥å…·å‡½æ•°
function timestampToDate(timestamp) {
    if (!timestamp) return '';
    const date = new Date(timestamp * 1000);
    return date.toISOString().split('T')[0];
}

// åˆ‡æ¢æ‰‹åŠ¨è®¾ç½®å›½å®¶çš„UIæ˜¾ç¤º
function toggleLocationManual() {
    const checkbox = document.getElementById('edit_location_manual');
    const toggle = document.getElementById('location-manual-toggle');
    const container = document.getElementById('country-select-container');
    const fetchContainer = document.getElementById('fetch-location-container');

    // åˆ‡æ¢å¤é€‰æ¡†çŠ¶æ€
    checkbox.checked = !checkbox.checked;

    // æ›´æ–°å¼€å…³æ ·å¼
    if (checkbox.checked) {
        toggle.classList.add('translate-x-5', 'bg-purple-500');
        container.classList.remove('hidden');
        fetchContainer.classList.add('hidden');
    } else {
        toggle.classList.remove('translate-x-5', 'bg-purple-500');
        container.classList.add('hidden');
        fetchContainer.classList.remove('hidden');
    }
}

/**
 * æ‰‹åŠ¨è·å–æœåŠ¡å™¨ä½ç½®ä¿¡æ¯
 */
async function fetchLocationInfo() {
    try {
        const button = document.getElementById('fetch-location-button');
        const statusDiv = document.getElementById('location-status');

        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        button.disabled = true;
        button.innerHTML = '<i class="material-icons animate-spin text-base">refresh</i> <span>æ­£åœ¨è·å–...</span>';
        statusDiv.textContent = 'æ­£åœ¨è·å–ä½ç½®ä¿¡æ¯...';
        statusDiv.classList.remove('hidden', 'text-red-500', 'text-green-500');
        statusDiv.classList.add('text-purple-400');

        // è·å–æœåŠ¡å™¨ID
        const serverId = window.location.pathname.split('/').filter(Boolean).pop();

        // å‘é€è¯·æ±‚åˆ°æœåŠ¡å™¨
        const response = await fetch(`/api/admin/servers/${serverId}/fetch-location`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        });

        const data = await response.json();
        console.log('ä½ç½®ä¿¡æ¯æ›´æ–°å“åº”:', data);

        if (data.success) {
            // è·å–å›½å®¶ä»£ç å’Œå›½å®¶åç§°çš„æ˜ å°„
            const countryMap = {
                'CN': 'ä¸­å›½',
                'HK': 'é¦™æ¸¯',
                'TW': 'å°æ¹¾',
                'JP': 'æ—¥æœ¬',
                'KR': 'éŸ©å›½',
                'SG': 'æ–°åŠ å¡',
                'US': 'ç¾å›½',
                'CA': 'åŠ æ‹¿å¤§',
                'UK': 'è‹±å›½',
                'DE': 'å¾·å›½',
                'FR': 'æ³•å›½',
                'AU': 'æ¾³å¤§åˆ©äºš',
                'RU': 'ä¿„ç½—æ–¯',
                'UA': 'ä¹Œå…‹å…°',
                'BR': 'å·´è¥¿',
                'IN': 'å°åº¦',
                'ZA': 'å—é',
                'LO': 'æœ¬åœ°ç½‘ç»œ',
                'OT': 'å…¶ä»–åœ°åŒº'
            };

            // è·å–å›½å®¶åç§°å’Œåœ°åŒºä¿¡æ¯
            const location = data.location || {};
            const countryCode = location.code || 'Unknown';
            const countryName = location.name_zh || countryMap[countryCode] || countryCode;
            const region = location.region || location.country?.region || '';

            // æ„å»ºä½ç½®æ˜¾ç¤ºæ–‡æœ¬
            const locationText = region ? `${countryName} - ${region}` : countryName;

            // æ„å»ºæç¤ºæ¶ˆæ¯
            let message = '';
            if (data.unchanged) {
                message = `å½“å‰ä½ç½®ä¸º ${locationText} (${countryCode})ï¼Œä½ç½®ä¿¡æ¯æœªå‘ç”Ÿå˜åŒ–`;
            } else {
                const previous = location.previous;
                if (previous) {
                    const prevCode = previous.code || 'Unknown';
                    const prevName = previous.name_zh || countryMap[prevCode] || prevCode;
                    const prevRegion = previous.region || previous.country?.region || '';
                    const prevLocationText = prevRegion ? `${prevName} - ${prevRegion}` : prevName;

                    message = `ä½ç½®ä¿¡æ¯å·²æ›´æ–°ï¼š${prevLocationText} (${prevCode}) â†’ ${locationText} (${countryCode})`;
                } else {
                    message = `ä½ç½®ä¿¡æ¯å·²æ›´æ–°ï¼š${locationText} (${countryCode})`;
                }
            }

            statusDiv.textContent = message;
            statusDiv.classList.remove('text-purple-400', 'text-red-500');
            statusDiv.classList.add('text-green-500');

            // å¦‚æœä½ç½®ä¿¡æ¯æœ‰æ›´æ–°ï¼Œ3ç§’ååˆ·æ–°é¡µé¢
            if (!data.unchanged) {
                setTimeout(() => {
                    window.location.reload();
                }, 3000);
            }
        } else {
            // æ›´æ–°å¤±è´¥
            const errorMessage = data.message || data.error || 'è·å–ä½ç½®ä¿¡æ¯å¤±è´¥';
            console.error('ä½ç½®ä¿¡æ¯æ›´æ–°å¤±è´¥:', errorMessage);
            throw new Error(errorMessage);
        }
    } catch (error) {
        const statusDiv = document.getElementById('location-status');

        // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
        statusDiv.textContent = error.message || 'è·å–ä½ç½®ä¿¡æ¯å¤±è´¥';
        statusDiv.classList.remove('hidden', 'text-purple-400');
        statusDiv.classList.add('text-red-500');
        console.error('è·å–ä½ç½®ä¿¡æ¯å¤±è´¥:', error);
    } finally {
        // æ¢å¤æŒ‰é’®çŠ¶æ€
        const button = document.getElementById('fetch-location-button');
        setTimeout(() => {
            button.disabled = false;
            button.innerHTML = '<i class="material-icons text-base">location_on</i> <span>æ‰‹åŠ¨è·å–ä½ç½®</span>';
        }, 1000);

        // ç¡®ä¿çŠ¶æ€ä¿¡æ¯å¯è§
        const statusDiv = document.getElementById('location-status');
        statusDiv.classList.remove('hidden');
    }
}

function dateStringToTimestamp(dateString) {
    if (!dateString) return 0;
    const date = new Date(dateString);
    return Math.floor(date.getTime() / 1000);
}

// åˆå§‹åŒ–è¡¨å•æ•°æ®
function initForm(server) {
    console.log('åˆå§‹åŒ–æœåŠ¡å™¨æ•°æ®:', server);

    // åŸºæœ¬ä¿¡æ¯
    document.getElementById('sid').value = server.sid;
    document.getElementById('edit_name').value = server.name;
    document.getElementById('edit_status').value = server.status;
    document.getElementById('edit_top').value = server.top;
    if (server.expire_time) {
        document.getElementById('edit_expire_time').value = timestampToDate(server.expire_time);
    }

    // SSHè®¾ç½®
    document.getElementById('edit_ssh_host').value = server.data.ssh.host;
    document.getElementById('edit_ssh_port').value = server.data.ssh.port || '';
    document.getElementById('edit_ssh_username').value = server.data.ssh.username || '';
    document.getElementById('edit_ssh_password').value = server.data.ssh.password || '';
    document.getElementById('edit_ssh_pri').value = server.data.ssh.privateKey || '';

    // è®¾å¤‡å’ŒAPIè®¾ç½®
    document.getElementById('edit_device').value = server.data.device || '';
    document.getElementById('edit_api_key').value = server.data.api?.key || '';
    document.getElementById('edit_api_port').value = server.data.api?.port || '';

    // æµé‡è®¾ç½®
    document.getElementById('edit_traffic_limit').value = TrafficFormat.bytesToGB(server.traffic_limit);
    document.getElementById('edit_traffic_reset_day').value = server.traffic_reset_day || 1;
    document.getElementById('edit_traffic_alert_percent').value = server.traffic_alert_percent || 80;
    document.getElementById('edit_traffic_calibration_date').value = timestampToDate(server.traffic_calibration_date);
    document.getElementById('edit_traffic_calibration_value').value = TrafficFormat.bytesToGB(server.traffic_calibration_value);
}

// ç¼–è¾‘æœåŠ¡å™¨
async function edit() {
    try {
        startloading();

        // åŸºç¡€æ•°æ®éªŒè¯
        const name = V('edit_name');
        const host = V('edit_ssh_host');

        if (!name || !host) {
            notice('æœåŠ¡å™¨åç§°å’ŒIPåœ°å€ä¸èƒ½ä¸ºç©º', 'error');
            return;
        }

        // æ„é€ æœåŠ¡å™¨é…ç½®æ•°æ® - ä¸æ£€æŸ¥SSHå‡­æ®ï¼Œå…è®¸æ— å‡­æ®ä¿å­˜
        const serverData = {
            ssh: {
                host: host,
                port: parseInt(V('edit_ssh_port')) || 22,
                username: V('edit_ssh_username'),
                password: V('edit_ssh_password'),
                pri: V('edit_ssh_pri')
            },
            api: {
                key: V('edit_api_key') || '',
                port: parseInt(V('edit_api_port')) || 8080
            },
            device: V('edit_device') || ''
        };

        // æ·»åŠ ä½ç½®ä¿¡æ¯
        const isManualLocation = document.getElementById('edit_location_manual').checked;
        if (isManualLocation) {
            // è·å–é€‰æ‹©çš„å›½å®¶ä»£ç 
            const countryCode = V('edit_location_country_code');
            const countrySelect = document.getElementById('edit_location_country_code');
            const selectedOption = countrySelect.options[countrySelect.selectedIndex];

            // è·å–å›½å®¶åç§°å’Œå›½æ——emoji
            const flagAndName = selectedOption.textContent.trim();

            // æ­£ç¡®æå–å›½æ——emojiï¼ˆå›½æ——emojié€šå¸¸æ˜¯ä¸¤ä¸ªåŒºåŸŸæŒ‡ç¤ºç¬¦ï¼‰
            // åœ¨æˆ‘ä»¬çš„é€‰é¡¹ä¸­ï¼Œå›½æ——æ˜¯å¼€å¤´çš„å…ƒç´ ï¼Œå¹¶ä¸”ä»ç¬¬ä¸€ä¸ªç©ºæ ¼å‰çš„å†…å®¹
            const spaceIndex = flagAndName.indexOf(' ');
            const flag = spaceIndex > 0 ? flagAndName.substring(0, spaceIndex) : 'ğŸŒ';

            // æå–å›½å®¶åç§°ï¼ˆç©ºæ ¼ååˆ°æ‹¬å·å‰çš„å†…å®¹ï¼‰
            const name = spaceIndex > 0 ? flagAndName.substring(spaceIndex + 1).split(' (')[0] : countryCode;

            // æ·»åŠ åˆ°æœåŠ¡å™¨æ•°æ®ä¸­
            serverData.location = {
                country: {
                    code: countryCode,         // å›½å®¶ä»£ç ï¼Œç”¨äºæ˜¾ç¤ºï¼ˆå¦‚CN, USï¼‰
                    name: name,                // å›½å®¶è‹±æ–‡åç§°
                    name_zh: name,             // å›½å®¶ä¸­æ–‡åç§°
                    flag: flag,                // å›½æ——emojiç¬¦å·
                    continent: 'Unknown',      // å¤§é™†ä¿¡æ¯ï¼ˆå¯é€‰ï¼‰
                    region: 'Unknown',         // åŒºåŸŸä¿¡æ¯ï¼ˆå¯é€‰ï¼‰
                    manual: true,              // æ ‡è®°ä¸ºæ‰‹åŠ¨è®¾ç½®
                    updated_at: Date.now()     // æ›´æ–°æ—¶é—´æˆ³
                }
            };
        }

        // æ„é€ è¯·æ±‚æ•°æ®
        const requestData = {
            name,
            data: JSON.stringify(serverData),
            status: parseInt(V('edit_status')),
            top: parseInt(V('edit_top')) || 0,
            expire_time: V('edit_expire_time') ?
                Math.floor(new Date(V('edit_expire_time') + ' 23:59:59').getTime() / 1000) :
                null,
            group_id: V('edit_group_id') || 'default',
            traffic_limit: TrafficFormat.gbToBytes(V('edit_traffic_limit')),
            traffic_reset_day: parseInt(V('edit_traffic_reset_day')) || 1,
            traffic_alert_percent: parseInt(V('edit_traffic_alert_percent')) || 80,
            traffic_calibration_date: V('edit_traffic_calibration_date') ?
                Math.floor(new Date(V('edit_traffic_calibration_date')).getTime() / 1000) :
                null,
            traffic_calibration_value: TrafficFormat.gbToBytes(V('edit_traffic_calibration_value'))
        };

        console.log('æäº¤çš„æ•°æ®:', requestData);

        const sid = V('sid');
        const res = await postjson(`/admin/servers/${sid}/edit`, requestData);

        if (res.status) {
            notice('ä¿å­˜æˆåŠŸ', 'success');
            // ä¿æŒåœ¨å½“å‰é¡µé¢ï¼Œä¸å†è·³è½¬
        } else {
            notice(res.data || 'ä¿å­˜å¤±è´¥ï¼Œè¯·æ£€æŸ¥å¿…å¡«é¡¹', 'error');
        }
    } catch (error) {
        console.error('ä¿å­˜å¤±è´¥:', error);
        // ä¼˜åŒ–é”™è¯¯æç¤º
        if (error.message && error.message.includes('handleInstallation')) {
            notice('ä¿å­˜æˆåŠŸï¼Œä½†è‡ªåŠ¨å®‰è£…å¤±è´¥ã€‚æ‚¨å¯ä»¥ç¨åæ‰‹åŠ¨å®‰è£…ã€‚', 'info');
        } else {
            notice('ä¿å­˜å¤±è´¥: ' + (error.message || 'å‘ç”ŸæœªçŸ¥é”™è¯¯'), 'error');
        }
    } finally {
        endloading();
    }
}

// åˆ é™¤æœåŠ¡å™¨
async function del() {
    if (!confirm('ç¡®å®šè¦åˆ é™¤è¯¥æœåŠ¡å™¨å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) {
        return;
    }

    try {
        startloading();
        const sid = V('sid');
        const res = await postjson(`/admin/servers/${sid}/del`);

        if (res.status) {
            notice('åˆ é™¤æˆåŠŸ', 'success');
            setTimeout(() => location.href = '/admin/servers', 1000);
        } else {
            notice(res.data || 'åˆ é™¤å¤±è´¥', 'error');
        }
    } catch (error) {
        console.error('åˆ é™¤å¤±è´¥:', error);
        notice('åˆ é™¤å¤±è´¥: ' + (error.message || 'æœªçŸ¥é”™è¯¯'), 'error');
    } finally {
        endloading();
    }
}

// æ˜¾ç¤ºæç¤ºæ¶ˆæ¯
function showToast(message, type = 'info') {
    const toast = document.createElement('div');
    toast.className = `fixed top-4 right-4 p-4 rounded-lg shadow-lg z-50 ${
        type === 'error' ? 'bg-red-500' :
        type === 'success' ? 'bg-green-500' :
        'bg-purple-500'
    } text-white`;
    toast.textContent = message;

    document.body.appendChild(toast);

    setTimeout(() => {
        toast.classList.add('opacity-0', 'transition-opacity');
        setTimeout(() => toast.remove(), 300);
    }, 3000);
}
</script>

<script>
// æ·»åŠ å¼¹çª—æ§åˆ¶å‡½æ•°
function showInstallModal(title = 'ç³»ç»Ÿå®‰è£…ä¸­', status = 'æ­£åœ¨å®‰è£…ç³»ç»Ÿç»„ä»¶...') {
    const modal = document.getElementById('install-progress-modal');
    if (modal) {
        modal.querySelector('h3').textContent = title;
        document.getElementById('install-status').textContent = status;
        document.getElementById('install-log').textContent = ''; // æ¸…ç©ºæ—¥å¿—
        modal.classList.remove('hidden');
    }
}

function hideInstallModal() {
    const modal = document.getElementById('install-progress-modal');
    if (modal) {
        modal.classList.add('hidden');
    }
}

function updateInstallStatus(status) {
    const statusElement = document.getElementById('install-status');
    if (statusElement) {
        statusElement.textContent = status;
    }
}

function updateInstallLog(log) {
    const logElement = document.getElementById('install-log');
    if (logElement) {
        logElement.textContent = log;
        // æ»šåŠ¨åˆ°æ—¥å¿—åº•éƒ¨
        const container = document.getElementById('install-log-container');
        if (container) {
            container.scrollTop = container.scrollHeight;
        }
    }
}

// ä¿®æ”¹ç°æœ‰çš„ init å‡½æ•°
async function init() {
    if (!confirm('ç¡®è®¤é‡æ–°å®‰è£…æ¢é’ˆï¼Ÿè¿™å¯èƒ½éœ€è¦å‡ åˆ†é’Ÿæ—¶é—´ã€‚')) {
        return;
    }

    showInstallModal('é‡æ–°å®‰è£…æ¢é’ˆ', 'æ­£åœ¨å®‰è£…ç³»ç»Ÿç»„ä»¶...');
    try {
        const sid = V('sid');
        const res = await postjson(`/admin/servers/${sid}/init`);

        // å¦‚æœæœ‰å®‰è£…æ—¥å¿—ï¼Œæ˜¾ç¤ºå®‰è£…æ—¥å¿—
        if (res.log) {
            updateInstallLog(res.log);
        }

        if (res.status) {
            // æ›´æ–°çŠ¶æ€
            updateInstallStatus('å®‰è£…æˆåŠŸï¼');

            // æ˜¾ç¤ºæˆåŠŸé€šçŸ¥
            notice('å®‰è£…æˆåŠŸï¼', 'success');

            // å»¶æ—¶å…³é—­å¼¹çª—ï¼Œç»™ç”¨æˆ·æ—¶é—´æŸ¥çœ‹æ—¥å¿—
            setTimeout(() => {
                hideInstallModal();
            }, 3000);
        } else {
            // æ›´æ–°çŠ¶æ€
            updateInstallStatus('å®‰è£…å¤±è´¥');

            // æ˜¾ç¤ºé”™è¯¯æ—¥å¿—
            if (res.log) {
                updateInstallLog(res.log);
            }

            // å»¶æ—¶å…³é—­å¼¹çª—ï¼Œç»™ç”¨æˆ·æ—¶é—´æŸ¥çœ‹é”™è¯¯æ—¥å¿—
            setTimeout(() => {
                const errorMsg = res.data || 'æœªçŸ¥é”™è¯¯';
                const retryInstall = confirm(`æ¢é’ˆå®‰è£…å¤±è´¥: ${errorMsg}\n\næ˜¯å¦é‡è¯•å®‰è£…ï¼Ÿ`);

                hideInstallModal();

                if (retryInstall) {
                    return init(); // é€’å½’è°ƒç”¨é‡è¯•
                } else {
                    notice('æ¢é’ˆå®‰è£…å¤±è´¥', 'error');
                }
            }, 3000);
        }
    } catch (error) {
        console.error('å®‰è£…å¤±è´¥:', error);

        // æ›´æ–°çŠ¶æ€
        updateInstallStatus('å®‰è£…è¿‡ç¨‹å‡ºé”™');

        // æ˜¾ç¤ºé”™è¯¯æ—¥å¿—
        updateInstallLog(`é”™è¯¯: ${error.message || 'æœªçŸ¥é”™è¯¯'}`);

        // å»¶æ—¶å…³é—­å¼¹çª—ï¼Œç»™ç”¨æˆ·æ—¶é—´æŸ¥çœ‹é”™è¯¯æ—¥å¿—
        setTimeout(() => {
            const retryInstall = confirm(`å®‰è£…è¿‡ç¨‹å‡ºé”™: ${error.message || 'æœªçŸ¥é”™è¯¯'}\n\næ˜¯å¦é‡è¯•å®‰è£…ï¼Ÿ`);

            hideInstallModal();

            if (retryInstall) {
                return init(); // é€’å½’è°ƒç”¨é‡è¯•
            } else {
                notice('æ¢é’ˆå®‰è£…å¤±è´¥: ' + (error.message || 'æœªçŸ¥é”™è¯¯'), 'error');
            }
        }, 3000);
    }
}

// ä¿®æ”¹ç°æœ‰çš„ update å‡½æ•°
async function update() {
    if (!confirm('ç¡®è®¤æ›´æ–°æ¢é’ˆï¼Ÿè¿™å¯èƒ½éœ€è¦å‡ åˆ†é’Ÿæ—¶é—´ã€‚')) {
        return;
    }

    showInstallModal('æ›´æ–°æ¢é’ˆ', 'æ­£åœ¨æ›´æ–°ç³»ç»Ÿ...');
    try {
        const sid = V('sid');
        const res = await postjson(`/admin/servers/${sid}/update`);

        if (res.status) {
            notice('æ›´æ–°æˆåŠŸï¼', 'success');
            setTimeout(() => {
                hideInstallModal();
            }, 1000);
        } else {
            hideInstallModal();
            const errorMsg = res.data || 'æœªçŸ¥é”™è¯¯';
            const retryUpdate = confirm(`æ¢é’ˆæ›´æ–°å¤±è´¥: ${errorMsg}\n\næ˜¯å¦é‡è¯•æ›´æ–°ï¼Ÿ`);

            if (retryUpdate) {
                return update(); // é€’å½’è°ƒç”¨é‡è¯•
            } else {
                notice('æ¢é’ˆæ›´æ–°å¤±è´¥', 'error');
            }
        }
    } catch (error) {
        console.error('æ›´æ–°å¤±è´¥:', error);
        hideInstallModal();

        const retryUpdate = confirm(`æ›´æ–°è¿‡ç¨‹å‡ºé”™: ${error.message || 'æœªçŸ¥é”™è¯¯'}\n\næ˜¯å¦é‡è¯•æ›´æ–°ï¼Ÿ`);
        if (retryUpdate) {
            return update(); // é€’å½’è°ƒç”¨é‡è¯•
        } else {
            notice('æ¢é’ˆæ›´æ–°å¤±è´¥: ' + (error.message || 'æœªçŸ¥é”™è¯¯'), 'error');
        }
    } finally {
        hideInstallModal();
    }
}

// æ·»åŠ ç§é’¥æ–‡ä»¶å¤„ç†å‡½æ•°
document.getElementById('edit_ssh_pri_file').addEventListener('change', function(event) {
    const file = event.target.files[0];
    if (!file) return;

    // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
    startloading();

    const reader = new FileReader();
    reader.onload = function(e) {
        const content = e.target.result;
        document.getElementById('edit_ssh_pri').value = content;
        endloading();
        notice('ç§é’¥æ–‡ä»¶å·²åŠ è½½', 'success');
    };

    reader.onerror = function(e) {
        console.error('è¯»å–æ–‡ä»¶å¤±è´¥:', e);
        endloading();
        notice('è¯»å–æ–‡ä»¶å¤±è´¥', 'error');
    };

    reader.readAsText(file);
});

// æ·»åŠ æµ‹è¯•SSHè¿æ¥å‡½æ•°
async function testSSHConnection() {
    try {
        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€ï¼Œé‡ç½®ç»“æœåŒºåŸŸ
        startloading();
        const resultEl = document.getElementById('ssh-test-result');
        resultEl.classList.add('hidden');
        resultEl.textContent = '';
        resultEl.classList.remove('text-green-500', 'text-red-500');

        // åŸºæœ¬éªŒè¯
        const host = V('edit_ssh_host');
        if (!host) {
            notice('è¯·è¾“å…¥æœåŠ¡å™¨åœ°å€', 'error');
            return;
        }

        const username = V('edit_ssh_username') || 'root';
        const port = V('edit_ssh_port') || 22;
        const password = V('edit_ssh_password');
        const privateKey = V('edit_ssh_pri');
        const passphrase = V('edit_ssh_passphrase');

        if (!password && !privateKey) {
            notice('æµ‹è¯•è¿æ¥éœ€è¦SSHå¯†ç æˆ–ç§é’¥ï¼Œä½†æ‚¨å¯ä»¥ä¸æä¾›è¿™äº›ä¿¡æ¯ä¹Ÿèƒ½ä¿å­˜æœåŠ¡å™¨', 'info');
            endloading();
            return;
        }

        // å‘é€æµ‹è¯•è¯·æ±‚
        const response = await fetch('/admin/test-ssh', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                host,
                port,
                username,
                password,
                privateKey,
                passphrase
            })
        });

        const result = await response.json();

        // æ˜¾ç¤ºç»“æœ
        resultEl.classList.remove('hidden');

        if (result.status) {
            notice('è¿æ¥æˆåŠŸ', 'success');
            resultEl.textContent = 'âœ“ è¿æ¥æˆåŠŸ';
            resultEl.classList.add('text-green-500');
        } else {
            notice(result.data || 'è¿æ¥å¤±è´¥', 'error');
            resultEl.textContent = 'âœ— ' + (result.data || 'è¿æ¥å¤±è´¥');
            resultEl.classList.add('text-red-500');

            // å¦‚æœæœ‰è¯¦ç»†é”™è¯¯ä¿¡æ¯ï¼Œæ·»åŠ åˆ°ç»“æœä¸­
            if (result.details) {
                console.error('è¿æ¥é”™è¯¯è¯¦æƒ…:', result.details);
            }

            // æ£€æŸ¥æ˜¯å¦æ˜¯ç§é’¥å¯†ç é—®é¢˜
            if (result.data && result.data.includes('ç§é’¥è§£å¯†å¤±è´¥') && privateKey && !passphrase) {
                resultEl.textContent += 'ï¼Œè¯·å°è¯•æä¾›ç§é’¥å¯†ç ';
            }
        }
    } catch (error) {
        console.error('æµ‹è¯•SSHè¿æ¥å¤±è´¥:', error);
        notice(error.message || 'æµ‹è¯•è¿æ¥å¤±è´¥', 'error');

        // æ˜¾ç¤ºé”™è¯¯åˆ°ç»“æœåŒºåŸŸ
        const resultEl = document.getElementById('ssh-test-result');
        resultEl.classList.remove('hidden');
        resultEl.textContent = 'âœ— è¿æ¥è¯·æ±‚å¤±è´¥: ' + (error.message || 'æœªçŸ¥é”™è¯¯');
        resultEl.classList.add('text-red-500');
    } finally {
        endloading();
    }
}

// æ·»åŠ å¯†ç æ˜¾ç¤º/éšè—åŠŸèƒ½
document.querySelectorAll('.toggle-password').forEach(toggle => {
    toggle.addEventListener('click', function() {
        const input = this.parentElement.querySelector('input');
        const icon = this.querySelector('i');

        if (input.type === 'password') {
            input.type = 'text';
            icon.textContent = 'visibility_off';
        } else {
            input.type = 'password';
            icon.textContent = 'visibility';
        }
    });
});

// æ£€æŸ¥URLä¸­çš„é”šç‚¹ï¼Œå¦‚æœæ˜¯#installï¼Œåˆ™è‡ªåŠ¨è§¦å‘å®‰è£…
document.addEventListener('DOMContentLoaded', function() {
    if (window.location.hash === '#install') {
        // å»¶æ—¶ä¸€ä¸‹ï¼Œç¡®ä¿é¡µé¢å·²ç»åŠ è½½å®Œæˆ
        setTimeout(() => {
            init();
            // æ¸…é™¤é”šç‚¹ï¼Œé˜²æ­¢åˆ·æ–°é¡µé¢æ—¶å†æ¬¡è§¦å‘
            history.replaceState(null, null, window.location.pathname);
        }, 500);
    }
});
</script>
{% endblock %}
