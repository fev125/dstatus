{% set title = "ç¼–è¾‘æœåŠ¡å™¨" %}
{%set admin = true%}
{% extends "../../base.html" %}

{% block content %}
<!-- å¼•å…¥ä¾§è¾¹æ  -->
{% include "../sidebar.html" %}

<!-- ä¸»å†…å®¹åŒºåŸŸ -->
<div class="md:ml-64 p-4 transition-all duration-300">
<div class="max-w-7xl mx-auto">
    <!-- ç¼–è¾‘æœåŠ¡å™¨å¡ç‰‡ -->
    <div class="bg-slate-900/80 backdrop-blur rounded-lg border border-slate-800/50">
        <!-- å¡ç‰‡æ ‡é¢˜å’Œæ“ä½œæŒ‰é’® -->
        <div class="flex items-center justify-between p-4 border-b border-slate-800/50">
            <div class="flex items-center gap-3">
                <i class="material-icons text-blue-500">edit</i>
                <div>
                    <h3 class="text-lg font-medium text-white">{{server.name}}</h3>
                    <p class="text-sm text-slate-400">ç¼–è¾‘æœåŠ¡å™¨</p>
                </div>
            </div>
            <!-- ä¸»è¦æ“ä½œæŒ‰é’®ï¼šä¿å­˜å’Œåˆ é™¤ -->
            <div class="flex items-center gap-2">
                <button onclick="edit()" 
                        class="flex items-center gap-2 px-3 py-1.5 text-sm font-medium text-white bg-blue-500 hover:bg-blue-600 rounded-md transition-colors">
                    <i class="material-icons text-[18px]">save</i>
                    <span>ä¿å­˜</span>
                </button>
                <button onclick="del()"
                        class="flex items-center gap-2 px-3 py-1.5 text-sm font-medium text-white bg-red-500 hover:bg-red-600 rounded-md transition-colors">
                    <i class="material-icons text-[18px]">delete</i>
                    <span>åˆ é™¤</span>
                </button>
            </div>
        </div>

        <!-- éšè—å­—æ®µï¼šæœåŠ¡å™¨IDå’Œç½®é¡¶çŠ¶æ€ -->
        <input type="text" id='sid' value="{{server.sid}}" hidden>
        <input type="text" id='edit_top' value="{{server.top}}" hidden>

        <!-- è¡¨å•å†…å®¹åŒºåŸŸ -->
        <div class="p-6 space-y-8">
            <!-- åŸºæœ¬ä¿¡æ¯è®¾ç½® -->
            <div class="space-y-4">
                <h4 class="text-base font-medium text-slate-200">åŸºæœ¬ä¿¡æ¯</h4>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                    <!-- æœåŠ¡å™¨åç§° -->
                    <div>
                        <label class="block text-sm font-medium text-slate-400 mb-2">æœåŠ¡å™¨åç§°</label>
                        <input type="text" 
                               id="edit_name"
                               value="{{server.name}}"
                               class="w-full px-3 py-2 bg-slate-800/50 border border-slate-700 rounded-md text-slate-200 placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                    <!-- æœåŠ¡å™¨çŠ¶æ€é€‰æ‹© -->
                    <div>
                        <label class="block text-sm font-medium text-slate-400 mb-2">çŠ¶æ€</label>
                        <select id="edit_status"
                                class="w-full px-3 py-2 bg-slate-800/50 border border-slate-700 rounded-md text-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            {% for sta in ['1', '2', '0'] %}
                            {% set names = {'1':'æ­£å¸¸','2':'å¯¹å¤–éšè—','0':'ä¸å¯ç”¨'} %}
                            <option value="{{sta}}" {% if sta==server.status %}selected{% endif %}>{{names[sta]}}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <!-- åˆ°æœŸæ—¶é—´ -->
                    <div>
                        <label class="block text-sm font-medium text-slate-400 mb-2">åˆ°æœŸæ—¶é—´</label>
                        <input type="date" 
                               id="edit_expire_time"
                               value="{{server.expire_time|formatDate}}"
                               class="w-full px-3 py-2 bg-slate-800/50 border border-slate-700 rounded-md text-slate-200 placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <p class="mt-1 text-xs text-slate-500">ç•™ç©ºè¡¨ç¤ºæ°¸ä¹…æœ‰æ•ˆ</p>
                    </div>
                </div>
            </div>

            <!-- SSHè¿æ¥è®¾ç½® -->
            <div class="space-y-4">
                <h4 class="text-base font-medium text-slate-200">SSH è®¾ç½®</h4>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                    <!-- SSHè¿æ¥å‚æ•°ï¼šä¸»æœºã€ç«¯å£ã€ç”¨æˆ·å -->
                    <div>
                        <label class="block text-sm font-medium text-slate-400 mb-2">åŸŸå/IP</label>
                        <input type="text" 
                               id="edit_ssh_host"
                               value="{{server.data.ssh.host}}"
                               class="w-full px-3 py-2 bg-slate-800/50 border border-slate-700 rounded-md text-slate-200 placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-400 mb-2">ç«¯å£</label>
                        <input type="number" 
                               id="edit_ssh_port"
                               value="{{server.data.ssh.port}}"
                               class="w-full px-3 py-2 bg-slate-800/50 border border-slate-700 rounded-md text-slate-200 placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-400 mb-2">ç”¨æˆ·å</label>
                        <input type="text" 
                               id="edit_ssh_username"
                               value="{{server.data.ssh.username}}"
                               class="w-full px-3 py-2 bg-slate-800/50 border border-slate-700 rounded-md text-slate-200 placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-400 mb-2">å¯†ç  (å¯é€‰)</label>
                        <input type="text" 
                               id="edit_ssh_password"
                               value="{{server.data.ssh.password}}"
                               class="w-full px-3 py-2 bg-slate-800/50 border border-slate-700 rounded-md text-slate-200 placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                    <div class="md:col-span-2 lg:col-span-3 xl:col-span-4">
                        <label class="block text-sm font-medium text-slate-400 mb-2">ç§é’¥ (å¯é€‰)</label>
                        <input type="text" 
                               id="edit_ssh_pri"
                               value="{{server.data.ssh.pri}}"
                               class="w-full px-3 py-2 bg-slate-800/50 border border-slate-700 rounded-md text-slate-200 placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                </div>
            </div>

            <!-- æµé‡è®¾ç½® -->
            <div class="space-y-4">
                <h4 class="text-base font-medium text-slate-200">æµé‡è®¾ç½®</h4>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                    <!-- æ¯æœˆæµé‡é™åˆ¶ -->
                    <div>
                        <label class="block text-sm font-medium text-slate-400 mb-2">æ¯æœˆæµé‡é™åˆ¶ (GB)</label>
                        <input type="number" 
                               id="edit_traffic_limit"
                               value="{{server.traffic_limit|bytesToGB}}"
                               class="w-full px-3 py-2 bg-slate-800/50 border border-slate-700 rounded-md text-slate-200 placeholder-slate-400"
                               placeholder="0">
                    </div>
                    
                    <!-- æµé‡é‡ç½®æ—¥ -->
                    <div>
                        <label class="block text-sm font-medium text-slate-400 mb-2">æµé‡é‡ç½®æ—¥</label>
                        <input type="number" 
                               id="edit_traffic_reset_day"
                               value="{{server.traffic_reset_day|default(1)}}"
                               min="1"
                               max="31"
                               class="w-full px-3 py-2 bg-slate-800/50 border border-slate-700 rounded-md text-slate-200 placeholder-slate-400"
                               placeholder="1">
                    </div>

                    <!-- æµé‡é¢„è­¦é˜ˆå€¼ -->
                    <div>
                        <label class="block text-sm font-medium text-slate-400 mb-2">æµé‡é¢„è­¦é˜ˆå€¼ (%)</label>
                        <input type="number" 
                               id="edit_traffic_alert_percent"
                               value="{{server.traffic_alert_percent|default(80)}}"
                               min="0"
                               max="100"
                               class="w-full px-3 py-2 bg-slate-800/50 border border-slate-700 rounded-md text-slate-200 placeholder-slate-400"
                               placeholder="80">
                    </div>

                    <!-- æµé‡æ ¡å‡†æ—¥æœŸ -->
                    <div>
                        <label class="block text-sm font-medium text-slate-400 mb-2">æµé‡æ ¡å‡†æ—¥æœŸ</label>
                        <input type="date" 
                               id="edit_traffic_calibration_date"
                               value="{{server.traffic_calibration_date|formatDate}}"
                               class="w-full px-3 py-2 bg-slate-800/50 border border-slate-700 rounded-md text-slate-200 placeholder-slate-400">
                    </div>

                    <!-- æ ¡å‡†æ—¶å·²ç”¨æµé‡ -->
                    <div>
                        <label class="block text-sm font-medium text-slate-400 mb-2">æ ¡å‡†æ—¶å·²ç”¨æµé‡ (GB)</label>
                        <input type="number" 
                               id="edit_traffic_calibration_value"
                               value="{{server.traffic_calibration_value|bytesToGB}}"
                               step="0.01"
                               class="w-full px-3 py-2 bg-slate-800/50 border border-slate-700 rounded-md text-slate-200 placeholder-slate-400"
                               placeholder="0">
                    </div>
                </div>
            </div>

            <!-- APIè®¾ç½® -->
            <div class="space-y-4">
                <h4 class="text-base font-medium text-slate-200">API è®¾ç½®</h4>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                    <div>
                        <label class="block text-sm font-medium text-slate-400 mb-2">é€šè®¯å¯†é’¥</label>
                        <input type="text" 
                               id="edit_api_key"
                               value="{{server.data.api.key}}"
                               class="w-full px-3 py-2 bg-slate-800/50 border border-slate-700 rounded-md text-slate-200 placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-400 mb-2">APIç«¯å£</label>
                        <input type="number" 
                               id="edit_api_port"
                               value="{{server.data.api.port}}"
                               min="1"
                               max="65535"
                               class="w-full px-3 py-2 bg-slate-800/50 border border-slate-700 rounded-md text-slate-200 placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-400 mb-2">ç½‘ç»œè®¾å¤‡</label>
                        <input type="text" 
                               id="edit_device"
                               value="{{server.data.device}}"
                               class="w-full px-3 py-2 bg-slate-800/50 border border-slate-700 rounded-md text-slate-200 placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                               placeholder="ä¾‹å¦‚: eth0">
                    </div>
                </div>
            </div>

            <!-- ä½ç½®è®¾ç½® -->
            <div class="space-y-4">
                <h4 class="text-base font-medium text-slate-200">ä½ç½®è®¾ç½®</h4>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                    <div>
                        <label class="block text-sm font-medium text-slate-400 mb-2">æ‰‹åŠ¨è®¾ç½®å›½å®¶</label>
                        <div class="flex items-center gap-3">
                            <div class="relative inline-block">
                                <input type="checkbox" 
                                       id="edit_location_manual"
                                       class="sr-only"
                                       {% if server.data.location.country.manual %}
                                       checked
                                       {% endif %}>
                                <div onclick="toggleLocationManual()"
                                     class="w-11 h-6 bg-slate-700 rounded-full cursor-pointer transition-colors relative">
                                    <div id="location-manual-toggle"
                                         class="w-5 h-5 rounded-full bg-white absolute left-0.5 top-0.5 transition-transform duration-200 transform
                                         {% if server.data.location.country.manual %}
                                         translate-x-5 bg-blue-500
                                         {% endif %}">
                                    </div>
                                </div>
                            </div>
                            <span class="text-sm text-slate-400">å¯ç”¨æ‰‹åŠ¨è®¾ç½®</span>
                        </div>
                    </div>
                    
                    <!-- æ‰‹åŠ¨è·å–ä½ç½®ä¿¡æ¯æŒ‰é’® -->
                    <div>
                        <label class="block text-sm font-medium text-slate-400 mb-2">è·å–ä½ç½®ä¿¡æ¯</label>
                        <div id="fetch-location-container" class="{% if server.data.location.country.manual %}hidden{% endif %}">
                            <button type="button" 
                                  id="fetch-location-button"
                                  onclick="fetchLocationInfo()"
                                  class="flex items-center gap-2 px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-md transition-colors">
                                <i class="material-icons text-base">location_on</i>
                                <span>æ‰‹åŠ¨è·å–ä½ç½®</span>
                            </button>
                            <div id="location-status" class="mt-2 text-sm text-slate-400 hidden"></div>
                        </div>
                    </div>
                    
                    <div id="country-select-container" class="{% if not server.data.location.country.manual %}hidden{% endif %}">
                        <label class="block text-sm font-medium text-slate-400 mb-2">å›½å®¶/åœ°åŒº</label>
                        <select id="edit_location_country_code"
                                class="w-full px-3 py-2 bg-slate-800/50 border border-slate-700 rounded-md text-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <option value="CN" {% if server.data.location.country.code == 'CN' %}selected{% endif %}>ğŸ‡¨ğŸ‡³ ä¸­å›½ (CN)</option>
                            <option value="HK" {% if server.data.location.country.code == 'HK' %}selected{% endif %}>ğŸ‡­ğŸ‡° é¦™æ¸¯ (HK)</option>
                            <option value="TW" {% if server.data.location.country.code == 'TW' %}selected{% endif %}>ğŸ‡¹ğŸ‡¼ å°æ¹¾ (TW)</option>
                            <option value="JP" {% if server.data.location.country.code == 'JP' %}selected{% endif %}>ğŸ‡¯ğŸ‡µ æ—¥æœ¬ (JP)</option>
                            <option value="KR" {% if server.data.location.country.code == 'KR' %}selected{% endif %}>ğŸ‡°ğŸ‡· éŸ©å›½ (KR)</option>
                            <option value="SG" {% if server.data.location.country.code == 'SG' %}selected{% endif %}>ğŸ‡¸ğŸ‡¬ æ–°åŠ å¡ (SG)</option>
                            <option value="US" {% if server.data.location.country.code == 'US' %}selected{% endif %}>ğŸ‡ºğŸ‡¸ ç¾å›½ (US)</option>
                            <option value="CA" {% if server.data.location.country.code == 'CA' %}selected{% endif %}>ğŸ‡¨ğŸ‡¦ åŠ æ‹¿å¤§ (CA)</option>
                            <option value="UK" {% if server.data.location.country.code == 'UK' %}selected{% endif %}>ğŸ‡¬ğŸ‡§ è‹±å›½ (UK)</option>
                            <option value="DE" {% if server.data.location.country.code == 'DE' %}selected{% endif %}>ğŸ‡©ğŸ‡ª å¾·å›½ (DE)</option>
                            <option value="FR" {% if server.data.location.country.code == 'FR' %}selected{% endif %}>ğŸ‡«ğŸ‡· æ³•å›½ (FR)</option>
                            <option value="AU" {% if server.data.location.country.code == 'AU' %}selected{% endif %}>ğŸ‡¦ğŸ‡º æ¾³å¤§åˆ©äºš (AU)</option>
                            <option value="RU" {% if server.data.location.country.code == 'RU' %}selected{% endif %}>ğŸ‡·ğŸ‡º ä¿„ç½—æ–¯ (RU)</option>
                            <option value="UA" {% if server.data.location.country.code == 'UA' %}selected{% endif %}>ğŸ‡ºğŸ‡¦ ä¹Œå…‹å…° (UA)</option>
                            <option value="BR" {% if server.data.location.country.code == 'BR' %}selected{% endif %}>ğŸ‡§ğŸ‡· å·´è¥¿ (BR)</option>
                            <option value="IN" {% if server.data.location.country.code == 'IN' %}selected{% endif %}>ğŸ‡®ğŸ‡³ å°åº¦ (IN)</option>
                            <option value="ZA" {% if server.data.location.country.code == 'ZA' %}selected{% endif %}>ğŸ‡¿ğŸ‡¦ å—é (ZA)</option>
                            <option value="LO" {% if server.data.location.country.code == 'LO' %}selected{% endif %}>ğŸ  æœ¬åœ°ç½‘ç»œ (LO)</option>
                            <option value="OT" {% if server.data.location.country.code == 'OT' or not server.data.location.country.code %}selected{% endif %}>ğŸŒ å…¶ä»–åœ°åŒº (OT)</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <!-- æ¢é’ˆç®¡ç† -->
            <div class="space-y-4">
                <h4 class="text-base font-medium text-slate-200">æ¢é’ˆç®¡ç†</h4>
                <div class="flex items-center gap-3">
                    <button onclick="init()" 
                            class="flex items-center gap-2 px-4 py-2 text-sm font-medium text-white bg-blue-500 hover:bg-blue-600 rounded-md transition-colors">
                        <i class="material-icons text-[18px]">download</i>
                        <span>å®‰è£…æ¢é’ˆ</span>
                    </button>
                    <button onclick="update()" 
                            class="flex items-center gap-2 px-4 py-2 text-sm font-medium text-white bg-green-500 hover:bg-green-600 rounded-md transition-colors">
                        <i class="material-icons text-[18px]">system_update</i>
                        <span>æ›´æ–°æ¢é’ˆ</span>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
</div>

<!-- å®‰è£…è¿›åº¦å¼¹çª— -->
<div id="install-progress-modal" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50">
    <div class="bg-slate-900 rounded-lg p-6 max-w-md w-full mx-4 border border-slate-800/50">
        <div class="text-center">
            <div class="animate-spin rounded-full h-12 w-12 border-4 border-blue-500 border-t-transparent mx-auto mb-4"></div>
            <h3 class="text-lg font-medium text-white mb-2">ç³»ç»Ÿå®‰è£…ä¸­</h3>
            <p id="install-status" class="text-sm text-slate-400 mb-4">æ­£åœ¨å®‰è£…ç³»ç»Ÿç»„ä»¶...</p>
            <div class="text-xs text-slate-500">å®‰è£…è¿‡ç¨‹å¯èƒ½éœ€è¦å‡ åˆ†é’Ÿï¼Œè¯·è€å¿ƒç­‰å¾…</div>
        </div>
    </div>
</div>
{%endblock%}

{%block js%}
<!-- å¼•å…¥æµé‡è½¬æ¢å·¥å…· -->
<script src="/js/traffic-format.js"></script>
<script>
// å·¥å…·å‡½æ•°
function timestampToDate(timestamp) {
    if (!timestamp) return '';
    const date = new Date(timestamp * 1000);
    return date.toISOString().split('T')[0];
}

// åˆ‡æ¢æ‰‹åŠ¨è®¾ç½®å›½å®¶çš„UIæ˜¾ç¤º
function toggleLocationManual() {
    const checkbox = document.getElementById('edit_location_manual');
    const toggle = document.getElementById('location-manual-toggle');
    const container = document.getElementById('country-select-container');
    const fetchContainer = document.getElementById('fetch-location-container');
    
    // åˆ‡æ¢å¤é€‰æ¡†çŠ¶æ€
    checkbox.checked = !checkbox.checked;
    
    // æ›´æ–°å¼€å…³æ ·å¼
    if (checkbox.checked) {
        toggle.classList.add('translate-x-5', 'bg-blue-500');
        container.classList.remove('hidden');
        fetchContainer.classList.add('hidden');
    } else {
        toggle.classList.remove('translate-x-5', 'bg-blue-500');
        container.classList.add('hidden');
        fetchContainer.classList.remove('hidden');
    }
}

/**
 * æ‰‹åŠ¨è·å–æœåŠ¡å™¨ä½ç½®ä¿¡æ¯
 */
async function fetchLocationInfo() {
    try {
        const button = document.getElementById('fetch-location-button');
        const statusDiv = document.getElementById('location-status');
        
        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        button.disabled = true;
        button.innerHTML = '<i class="material-icons animate-spin text-base">refresh</i> <span>æ­£åœ¨è·å–...</span>';
        statusDiv.textContent = 'æ­£åœ¨è·å–ä½ç½®ä¿¡æ¯...';
        statusDiv.classList.remove('hidden', 'text-red-500');
        statusDiv.classList.add('text-blue-400');
        
        // è·å–æœåŠ¡å™¨ID
        const serverId = window.location.pathname.split('/').filter(Boolean).pop();
        
        // å‘é€è¯·æ±‚åˆ°æœåŠ¡å™¨
        const response = await fetch(`/api/admin/servers/${serverId}/fetch-location`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        if (!response.ok) {
            throw new Error(`HTTP error! Status: ${response.status}`);
        }
        
        const data = await response.json();
        
        if (data.success) {
            // æ›´æ–°æˆåŠŸ
            statusDiv.textContent = 'ä½ç½®ä¿¡æ¯è·å–æˆåŠŸï¼Œåˆ·æ–°é¡µé¢æŸ¥çœ‹æœ€æ–°ä¿¡æ¯';
            statusDiv.classList.remove('text-blue-400', 'text-red-500');
            statusDiv.classList.add('text-green-500');
            
            // 3ç§’ååˆ·æ–°é¡µé¢
            setTimeout(() => {
                window.location.reload();
            }, 3000);
        } else {
            // æ›´æ–°å¤±è´¥
            throw new Error(data.message || 'è·å–ä½ç½®ä¿¡æ¯å¤±è´¥');
        }
    } catch (error) {
        const button = document.getElementById('fetch-location-button');
        const statusDiv = document.getElementById('location-status');
        
        // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
        statusDiv.textContent = `è·å–å¤±è´¥: ${error.message}`;
        statusDiv.classList.remove('hidden', 'text-blue-400');
        statusDiv.classList.add('text-red-500');
        console.error('è·å–ä½ç½®ä¿¡æ¯å¤±è´¥:', error);
    } finally {
        // æ¢å¤æŒ‰é’®çŠ¶æ€
        const button = document.getElementById('fetch-location-button');
        setTimeout(() => {
            button.disabled = false;
            button.innerHTML = '<i class="material-icons text-base">location_on</i> <span>æ‰‹åŠ¨è·å–ä½ç½®</span>';
        }, 1000);
    }
}

function dateStringToTimestamp(dateString) {
    if (!dateString) return 0;
    const date = new Date(dateString);
    return Math.floor(date.getTime() / 1000);
}

// åˆå§‹åŒ–è¡¨å•æ•°æ®
function initForm(server) {
    console.log('åˆå§‹åŒ–æœåŠ¡å™¨æ•°æ®:', server);
    
    // åŸºæœ¬ä¿¡æ¯
    document.getElementById('sid').value = server.sid;
    document.getElementById('edit_name').value = server.name;
    document.getElementById('edit_status').value = server.status;
    document.getElementById('edit_top').value = server.top;
    if (server.expire_time) {
        document.getElementById('edit_expire_time').value = timestampToDate(server.expire_time);
    }

    // SSHè®¾ç½®
    document.getElementById('edit_ssh_host').value = server.data.ssh.host;
    document.getElementById('edit_ssh_port').value = server.data.ssh.port || '';
    document.getElementById('edit_ssh_username').value = server.data.ssh.username || '';
    document.getElementById('edit_ssh_password').value = server.data.ssh.password || '';
    document.getElementById('edit_ssh_pri').value = server.data.ssh.privateKey || '';

    // è®¾å¤‡å’ŒAPIè®¾ç½®
    document.getElementById('edit_device').value = server.data.device || '';
    document.getElementById('edit_api_key').value = server.data.api?.key || '';
    document.getElementById('edit_api_port').value = server.data.api?.port || '';

    // æµé‡è®¾ç½®
    document.getElementById('edit_traffic_limit').value = TrafficFormat.bytesToGB(server.traffic_limit);
    document.getElementById('edit_traffic_reset_day').value = server.traffic_reset_day || 1;
    document.getElementById('edit_traffic_alert_percent').value = server.traffic_alert_percent || 80;
    document.getElementById('edit_traffic_calibration_date').value = timestampToDate(server.traffic_calibration_date);
    document.getElementById('edit_traffic_calibration_value').value = TrafficFormat.bytesToGB(server.traffic_calibration_value);
}

// ç¼–è¾‘æœåŠ¡å™¨
async function edit() {
    try {
        startloading();
        
        // åŸºç¡€æ•°æ®éªŒè¯
        const name = V('edit_name');
        const host = V('edit_ssh_host');
        
        if (!name || !host) {
            notice('æœåŠ¡å™¨åç§°å’ŒIPåœ°å€ä¸èƒ½ä¸ºç©º', 'error');
            return;
        }

        // æ„é€ æœåŠ¡å™¨é…ç½®æ•°æ®
        const serverData = {
            ssh: {
                host: host,
                port: parseInt(V('edit_ssh_port')) || 22,
                username: V('edit_ssh_username'),
                password: V('edit_ssh_password'),
                pri: V('edit_ssh_pri')
            },
            api: {
                key: V('edit_api_key') || '',
                port: parseInt(V('edit_api_port')) || 8080
            },
            device: V('edit_device') || ''
        };
        
        // æ·»åŠ ä½ç½®ä¿¡æ¯
        const isManualLocation = document.getElementById('edit_location_manual').checked;
        if (isManualLocation) {
            // è·å–é€‰æ‹©çš„å›½å®¶ä»£ç 
            const countryCode = V('edit_location_country_code');
            const countrySelect = document.getElementById('edit_location_country_code');
            const selectedOption = countrySelect.options[countrySelect.selectedIndex];
            
            // è·å–å›½å®¶åç§°å’Œå›½æ——emoji
            const flagAndName = selectedOption.textContent.trim();
            
            // æ­£ç¡®æå–å›½æ——emojiï¼ˆå›½æ——emojié€šå¸¸æ˜¯ä¸¤ä¸ªåŒºåŸŸæŒ‡ç¤ºç¬¦ï¼‰
            // åœ¨æˆ‘ä»¬çš„é€‰é¡¹ä¸­ï¼Œå›½æ——æ˜¯å¼€å¤´çš„å…ƒç´ ï¼Œå¹¶ä¸”ä»ç¬¬ä¸€ä¸ªç©ºæ ¼å‰çš„å†…å®¹
            const spaceIndex = flagAndName.indexOf(' ');
            const flag = spaceIndex > 0 ? flagAndName.substring(0, spaceIndex) : 'ğŸŒ';
            
            // æå–å›½å®¶åç§°ï¼ˆç©ºæ ¼ååˆ°æ‹¬å·å‰çš„å†…å®¹ï¼‰
            const name = spaceIndex > 0 ? flagAndName.substring(spaceIndex + 1).split(' (')[0] : countryCode;
            
            // æ·»åŠ åˆ°æœåŠ¡å™¨æ•°æ®ä¸­
            serverData.location = {
                country: {
                    code: countryCode,         // å›½å®¶ä»£ç ï¼Œç”¨äºæ˜¾ç¤ºï¼ˆå¦‚CN, USï¼‰
                    name: name,                // å›½å®¶è‹±æ–‡åç§°
                    name_zh: name,             // å›½å®¶ä¸­æ–‡åç§°
                    flag: flag,                // å›½æ——emojiç¬¦å·
                    continent: 'Unknown',      // å¤§é™†ä¿¡æ¯ï¼ˆå¯é€‰ï¼‰
                    region: 'Unknown',         // åŒºåŸŸä¿¡æ¯ï¼ˆå¯é€‰ï¼‰
                    manual: true,              // æ ‡è®°ä¸ºæ‰‹åŠ¨è®¾ç½®
                    updated_at: Date.now()     // æ›´æ–°æ—¶é—´æˆ³
                }
            };
        }

        // æ„é€ è¯·æ±‚æ•°æ®
        const requestData = {
            name,
            data: JSON.stringify(serverData),
            status: parseInt(V('edit_status')),
            top: parseInt(V('edit_top')) || 0,
            expire_time: V('edit_expire_time') ? 
                Math.floor(new Date(V('edit_expire_time') + ' 23:59:59').getTime() / 1000) : 
                null,
            traffic_limit: TrafficFormat.gbToBytes(V('edit_traffic_limit')),
            traffic_reset_day: parseInt(V('edit_traffic_reset_day')) || 1,
            traffic_alert_percent: parseInt(V('edit_traffic_alert_percent')) || 80,
            traffic_calibration_date: V('edit_traffic_calibration_date') ? 
                Math.floor(new Date(V('edit_traffic_calibration_date')).getTime() / 1000) : 
                null,
            traffic_calibration_value: TrafficFormat.gbToBytes(V('edit_traffic_calibration_value'))
        };

        console.log('æäº¤çš„æ•°æ®:', requestData);
        
        const sid = V('sid');
        const res = await postjson(`/admin/servers/${sid}/edit`, requestData);
        
        if (res.status) {
            notice('ä¿å­˜æˆåŠŸ', 'success');
            // ä¿æŒåœ¨å½“å‰é¡µé¢ï¼Œä¸å†è·³è½¬
        } else {
            notice(res.data || 'ä¿å­˜å¤±è´¥ï¼Œè¯·æ£€æŸ¥å¿…å¡«é¡¹', 'error');
        }
    } catch (error) {
        console.error('ä¿å­˜å¤±è´¥:', error);
        // ä¼˜åŒ–é”™è¯¯æç¤º
        if (error.message && error.message.includes('handleInstallation')) {
            notice('ä¿å­˜æˆåŠŸï¼Œä½†è‡ªåŠ¨å®‰è£…å¤±è´¥ã€‚æ‚¨å¯ä»¥ç¨åæ‰‹åŠ¨å®‰è£…ã€‚', 'info');
            // ä¿æŒåœ¨å½“å‰é¡µé¢ï¼Œä¸å†è·³è½¬
        } else {
            notice('ä¿å­˜å¤±è´¥: è¯·ç¡®ä¿æœåŠ¡å™¨åç§°å’ŒIPåœ°å€å·²å¡«å†™', 'error');
        }
    } finally {
        endloading();
    }
}

// åˆ é™¤æœåŠ¡å™¨
async function del() {
    if (!confirm('ç¡®å®šè¦åˆ é™¤è¯¥æœåŠ¡å™¨å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) {
        return;
    }

    try {
        startloading();
        const sid = V('sid');
        const res = await postjson(`/admin/servers/${sid}/del`);
        
        if (res.status) {
            notice('åˆ é™¤æˆåŠŸ', 'success');
            setTimeout(() => location.href = '/admin/servers', 1000);
        } else {
            notice(res.data || 'åˆ é™¤å¤±è´¥', 'error');
        }
    } catch (error) {
        console.error('åˆ é™¤å¤±è´¥:', error);
        notice('åˆ é™¤å¤±è´¥: ' + (error.message || 'æœªçŸ¥é”™è¯¯'), 'error');
    } finally {
        endloading();
    }
}

// æ˜¾ç¤ºæç¤ºæ¶ˆæ¯
function showToast(message, type = 'info') {
    const toast = document.createElement('div');
    toast.className = `fixed top-4 right-4 p-4 rounded-lg shadow-lg z-50 ${
        type === 'error' ? 'bg-red-500' : 
        type === 'success' ? 'bg-green-500' : 
        'bg-blue-500'
    } text-white`;
    toast.textContent = message;
    
    document.body.appendChild(toast);
    
    setTimeout(() => {
        toast.classList.add('opacity-0', 'transition-opacity');
        setTimeout(() => toast.remove(), 300);
    }, 3000);
}
</script>

<script>
// æ·»åŠ å¼¹çª—æ§åˆ¶å‡½æ•°
function showInstallModal(title = 'ç³»ç»Ÿå®‰è£…ä¸­', status = 'æ­£åœ¨å®‰è£…ç³»ç»Ÿç»„ä»¶...') {
    const modal = document.getElementById('install-progress-modal');
    if (modal) {
        modal.querySelector('h3').textContent = title;
        document.getElementById('install-status').textContent = status;
        modal.classList.remove('hidden');
    }
}

function hideInstallModal() {
    const modal = document.getElementById('install-progress-modal');
    if (modal) {
        modal.classList.add('hidden');
    }
}

function updateInstallStatus(status) {
    const statusElement = document.getElementById('install-status');
    if (statusElement) {
        statusElement.textContent = status;
    }
}

// ä¿®æ”¹ç°æœ‰çš„ init å‡½æ•°
async function init() {
    if (!confirm('ç¡®è®¤é‡æ–°å®‰è£…æ¢é’ˆï¼Ÿè¿™å¯èƒ½éœ€è¦å‡ åˆ†é’Ÿæ—¶é—´ã€‚')) {
        return;
    }
    
    showInstallModal('é‡æ–°å®‰è£…æ¢é’ˆ', 'æ­£åœ¨å®‰è£…ç³»ç»Ÿç»„ä»¶...');
    try {
        const sid = V('sid');
        const res = await postjson(`/admin/servers/${sid}/init`);
        
        if (res.status) {
            notice('å®‰è£…æˆåŠŸï¼', 'success');
            setTimeout(() => {
                hideInstallModal();
            }, 1000);
        } else {
            throw new Error(res.data || 'å®‰è£…å¤±è´¥');
        }
    } catch (error) {
        console.error('å®‰è£…å¤±è´¥:', error);
        notice(error.message || 'å®‰è£…å¤±è´¥', 'error');
    } finally {
        hideInstallModal();
    }
}

// ä¿®æ”¹ç°æœ‰çš„ update å‡½æ•°
async function update() {
    if (!confirm('ç¡®è®¤æ›´æ–°æ¢é’ˆï¼Ÿè¿™å¯èƒ½éœ€è¦å‡ åˆ†é’Ÿæ—¶é—´ã€‚')) {
        return;
    }
    
    showInstallModal('æ›´æ–°æ¢é’ˆ', 'æ­£åœ¨æ›´æ–°ç³»ç»Ÿ...');
    try {
        const sid = V('sid');
        const res = await postjson(`/admin/servers/${sid}/update`);
        
        if (res.status) {
            notice('æ›´æ–°æˆåŠŸï¼', 'success');
            setTimeout(() => {
                hideInstallModal();
            }, 1000);
        } else {
            throw new Error(res.data || 'æ›´æ–°å¤±è´¥');
        }
    } catch (error) {
        console.error('æ›´æ–°å¤±è´¥:', error);
        notice(error.message || 'æ›´æ–°å¤±è´¥', 'error');
    } finally {
        hideInstallModal();
    }
}
</script>
{%endblock%}
